/*! rapen 2013-10-29 */
(function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PropertyEdit=function(c){function e(){return this.unbindElement=b(this.unbindElement,this),this.updateElement=b(this.updateElement,this),this.setAttr=b(this.setAttr,this),this.bindElement=b(this.bindElement,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.bindElement=function(a){return this._bindingModel=a},e.prototype.setAttr=function(a){return this.set(a),this._bindingModel&&this._bindingModel.attr(a),this.trigger("update")},e.prototype.updateElement=function(){var a;return a={},_.each(this._bindingModel.el.attributes,function(b){return a[b.nodeName]=b.nodeValue}),this.clear(),this.set(a),this.trigger("update")},e.prototype.unbindElement=function(){return this._bindingModel=null,this.clear()},e}(Backbone.Model)}).call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgElement=function(c){function e(){return this.move=b(this.move,this),this.getPosition=b(this.getPosition,this),this._getPosition=b(this._getPosition,this),this._getBBoxPoints=b(this._getBBoxPoints,this),this._getMatrixBBoxPoints=b(this._getMatrixBBoxPoints,this),this.getBBoxPoints=b(this.getBBoxPoints,this),this.getCentorPoint=b(this.getCentorPoint,this),this.getLocalMatrix=b(this.getLocalMatrix,this),this.getSnapPoints=b(this.getSnapPoints,this),this.getScreenCTM=b(this.getScreenCTM,this),this.getCTM=b(this.getCTM,this),this.getBBox=b(this.getBBox,this),this.isGrouped=b(this.isGrouped,this),this.group=b(this.group,this),this.hide=b(this.hide,this),this.show=b(this.show,this),this.isVisibled=b(this.isVisibled,this),this.toggleLock=b(this.toggleLock,this),this.isLocked=b(this.isLocked,this),this.unLock=b(this.unLock,this),this.lock=b(this.lock,this),this.isSelected=b(this.isSelected,this),this.unSelect=b(this.unSelect,this),this.select=b(this.select,this),this.attr=b(this.attr,this),this.setMatrix=b(this.setMatrix,this),this.setElement=b(this.setElement,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.unSelect(),this.unLock()},e.prototype.setElement=function(a){return this.el=a,this.$el=$(a)},e.prototype.setMatrix=function(a){return SVGUtil.setMatrixTransform(this.el,a),this.set({matrix:a})},e.prototype.attr=function(a,b,c){var d;return"object"==typeof a?(d=a,c=b):(d={})[a]=b,$(this.el).attr(d),this.set(d)},e.prototype.select=function(){return this.set("_selected",!0)},e.prototype.unSelect=function(){return this.set("_selected",!1)},e.prototype.isSelected=function(){return this.get("_selected")},e.prototype.lock=function(){return this.set("_locked",!0)},e.prototype.unLock=function(){return this.set("_locked",!1)},e.prototype.isLocked=function(){return this.get("_locked")},e.prototype.toggleLock=function(){return this.isLocked()?this.unLock():this.lock()},e.prototype.isVisibled=function(){return"none"!==$(this.el).css("display")},e.prototype.show=function(){return $(this.el).css("display","inline")},e.prototype.hide=function(){return $(this.el).css("display","none")},e.prototype.group=function(){return this.set("_grouped",!0)},e.prototype.isGrouped=function(){return this.get("_grouped")},e.prototype.getBBox=function(){return this.el.getBBox()},e.prototype.getCTM=function(){return this.el.getCTM()},e.prototype.getScreenCTM=function(){return this.el.getScreenCTM()},e.prototype.getSnapPoints=function(){var a,b;return b=this.getBBoxPoints(),a=SVGUtil.createPoint((b[0].x+b[3].x)/2,(b[0].y+b[3].y)/2),b.push(a),b},e.prototype.getLocalMatrix=function(){return SVGUtil.localMatrix(this.el)},e.prototype.getCentorPoint=function(){var a,b,c;return c=this.getBBox(),a=this.el.getScreenCTM(),b=SVGUtil.SVG.createSVGPoint(),b.x=c.x+c.width/2,b.y=c.y+c.height/2,b=b.matrixTransform(a)},e.prototype.getBBoxPoints=function(){return this._getMatrixBBoxPoints(this.getCTM())},e.prototype._getMatrixBBoxPoints=function(a){var b,c;return b=this._getBBoxPoints(this.getBBox()),c=[],_.each(b,function(b){var d,e;return e=SVGUtil.createPoint(b[0],b[1]),d=e.matrixTransform(a),c.push(d)}),c},e.prototype._getBBoxPoints=function(a){var b,c,d,e,f,g,h,i,j;for(c=[],i=[a.x,a.x+a.width],e=0,g=i.length;g>e;e++)for(d=i[e],j=[a.y,a.y+a.height],f=0,h=j.length;h>f;f++)b=j[f],c.push([d,b]);return c},e.prototype._getPosition=function(a){var b,c;return c=this.getBBox(),b=SVGUtil.SVG.createSVGPoint(),b.x=c.x+c.width/2*(1+a.x),b.y=c.y+c.height/2*(1+a.y),b},e.prototype.getPosition=function(a){return this._getPosition(a).matrixTransform(this.getCTM())},e.prototype.move=function(a){var b,c;return c=SVGUtil.createPoint(a.x,a.y),b=this.getCTM().inverse(),b.e=0,b.f=0,c=c.matrixTransform(b),this.setMatrix(this.getLocalMatrix().translate(c.x,c.y))},e}(Backbone.Model)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};this.SvgElementList=function(b){function d(){return a=d.__super__.constructor.apply(this,arguments)}return c(d,b),d.prototype.model=SvgElement,d}(Backbone.Collection)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};this.SvgItem=function(b){function d(){return a=d.__super__.constructor.apply(this,arguments)}return c(d,b),d.prototype.initialize=function(){},d}(Backbone.Model)}.call(this),function(){var a,b={}.hasOwnProperty,c=function(a,c){function d(){this.constructor=a}for(var e in c)b.call(c,e)&&(a[e]=c[e]);return d.prototype=c.prototype,a.prototype=new d,a.__super__=c.prototype,a};this.SvgItemList=function(b){function d(){return a=d.__super__.constructor.apply(this,arguments)}return c(d,b),d.prototype.model=SvgItem,d}(Backbone.Collection)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PathSegmentAdapeter=function(c){function e(){return this.onChange=b(this.onChange,this),this.remove=b(this.remove,this),this.setLinear=b(this.setLinear,this),this.setSelected=b(this.setSelected,this),this.isSelected=b(this.isSelected,this),this.getPoint=b(this.getPoint,this),this.getHandleIn=b(this.getHandleIn,this),this.getHandleOut=b(this.getHandleOut,this),this.setSegment=b(this.setSegment,this),this.init=b(this.init,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.init=function(a){return this.segment=a,this.setSegment(this.segment)},e.prototype.setSegment=function(a){var b,c,d,e,f;for(this.point=new PathSegmentPointAdapeter,this.point.init(a.getPoint()),this.handleInPoint=new PathSegmentPointAdapeter,this.handleInPoint.init(a.getHandleIn()),this.handleOutPoint=new PathSegmentPointAdapeter,this.handleOutPoint.init(a.getHandleOut()),e=[this.point,this.handleInPoint,this.handleOutPoint],f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(b.on("change",this.onChange));return f},e.prototype.getHandleOut=function(){return this.handleOutPoint},e.prototype.getHandleIn=function(){return this.handleInPoint},e.prototype.getPoint=function(){return this.point},e.prototype.isSelected=function(){return this.segment.isSelected()},e.prototype.setSelected=function(a){return this.segment.setSelected(a),this.onChange(this)},e.prototype.setLinear=function(){return this.segment.setLinear(),this.onChange(this)},e.prototype.remove=function(){return this.segment.remove()},e.prototype.onChange=function(){var a;return a=Array.prototype.slice.call(arguments),a.unshift(this),a.unshift("change"),this.trigger.apply(this,a)},e}(Backbone.Model)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PathSegmentPointAdapeter=function(c){function e(){return this.getSavePoint=b(this.getSavePoint,this),this.savePoint=b(this.savePoint,this),this.setPoint=b(this.setPoint,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.init=function(a){return this.point=a},e.prototype.setPoint=function(a,b){return this.point.set(a,b),this.trigger("change",this)},e.prototype.getX=function(){return this.point.getX()},e.prototype.getY=function(){return this.point.getY()},e.prototype.savePoint=function(){return this.pre_point={x:this.getX(),y:this.getY()}},e.prototype.getSavePoint=function(){return this.pre_point},e}(Backbone.Model)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.CloneControlView=function(c){function e(){return this.attachDragEvent=b(this.attachDragEvent,this),this._copyItems=b(this._copyItems,this),this.attachCopyDragEvent=b(this.attachCopyDragEvent,this),this._copyMode=b(this._copyMode,this),this.onEvent=b(this.onEvent,this),this._setControlViewEvent=b(this._setControlViewEvent,this),this._setChildControlEvent=b(this._setChildControlEvent,this),this.render=b(this.render,this),this.clear=b(this.clear,this),this.hide=b(this.hide,this),this.addItem=b(this.addItem,this),this.removeItem=b(this.removeItem,this),this.exists=b(this.exists,this),this.initControls=b(this.initControls,this),this.lazyRender=b(this.lazyRender,this),this.update=b(this.update,this),this._viewUpdate=b(this._viewUpdate,this),this._updateForOneItem=b(this._updateForOneItem,this),this._onRemoveItem=b(this._onRemoveItem,this),this._onAddItem=b(this._onAddItem,this),this.firstOriginalItem=b(this.firstOriginalItem,this),this.firstItem=b(this.firstItem,this),this.isOneItem=b(this.isOneItem,this),this.getControlItem=b(this.getControlItem,this),this._onChangeList=b(this._onChangeList,this),this.setCanvas=b(this.setCanvas,this),this.getControl=b(this.getControl,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){var a,b;return this.manager=this.options.manager,this.canvas=this.options.canvas,this.item_list=new SvgElementList,this.line_list_view=new SelectLineListView({el:this.options.line_wrapper,line_view_class:CloneSelectLineView}),this.item_list.bind("add",this._onAddItem),this.item_list.bind("add",this._onChangeList),this.item_list.bind("remove",this._onRemoveItem),this.item_list.bind("remove",this._onChangeList),a=new SvgElement,a.setElement(this.el),b=new SvgElementView({model:a,el:a.el}),this.item=a,this._setControlViewEvent(b),this.itemControl=new ItemControl({el:this.options.select_el,manager:this}),this.mode="",this.lazy_render_set_timeout=null},e.prototype.getControl=function(){return this.itemControl},e.prototype.setCanvas=function(a){return this.canvas=a},e.prototype._onChangeList=function(){var a;return this.itemControl.clear(),this.stopListening(),this.isOneItem()?(a=this.firstOriginalItem(),this.listenTo(a,"change",this._updateForOneItem),this.itemControl.setItem(a),this.line_list_view.$el.hide(),this.$el.hide()):(this.listenTo(this.item,"change",this.update),this.itemControl.setItem(this.item),this.line_list_view.$el.show(),this.$el.show()),this.trigger("onChangeList",this)},e.prototype.getControlItem=function(){return this.itemControl.getItem()},e.prototype.isOneItem=function(){return 1===this.item_list.length},e.prototype.firstItem=function(){return this.item_list.at(0)},e.prototype.firstOriginalItem=function(){return this.item_list.length>0?this.item_list.at(0).get("origin_model"):null},e.prototype._onAddItem=function(a){var b;return b=new SvgElementView({model:a,el:a.el}),a.set("view",b),this._setChildControlEvent(b),this.line_list_view.item_list.add(a),b.render(),a.get("origin_model").select()},e.prototype._onRemoveItem=function(a){return a.get("origin_model").unSelect()},e.prototype._updateForOneItem=function(){var a;return a=this.firstItem(),a&&this._viewUpdate(a),this.line_list_view.render()},e.prototype._viewUpdate=function(a){var b,c,d;return d=a.get("view"),b=d.$el,c=a.get("origin_model").el.cloneNode(!0),a.el=c,this.$el.append(c),d.setElement(c),b.remove()},e.prototype.update=function(){var a,b=this;return a=this.item.getLocalMatrix(),this.item_list.each(function(c){var d,e;return e=c.get("origin_model"),d=c.getLocalMatrix(),"copy"===b.mode?e.setMatrix(d):e.setMatrix(a.multiply(d))}),this.line_list_view.render()},e.prototype.lazyRender=function(){var a=this;return this.lazy_render_set_timeout&&clearTimeout(this.lazy_render_set_timeout),this.lazy_render_set_timeout=setTimeout(function(){return a.render(),a.lazy_render_set_timeout=null},50)},e.prototype.initControls=function(a){var b,c,d,e;for(this.clear(),e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this.addItem(b));return e},e.prototype.exists=function(a){return this.item_list.find(function(b){return b.get("origin_model")===a})},e.prototype.removeItem=function(a){var b;return b=this.item_list.find(function(b){return b.get("origin_model")===a}),this.item_list.remove(b),this.lazyRender()},e.prototype.addItem=function(a){var b,c,d;return b=a.el.cloneNode(!0),d=this.item.getLocalMatrix().inverse().multiply(a.getLocalMatrix()),SVGUtil.setMatrixTransform(b,d),this.$el.append(b),c=new SvgElement,c.setElement(b),c.set("origin_model",a),this.item_list.add(c),this.lazyRender(),c},e.prototype.hide=function(){return this.$el.hide(),this.itemControl.visible=!1,this.itemControl.render(),this.line_list_view.$el.hide(),this.line_list_view.render()},e.prototype.clear=function(){var a;for(this.$el.hide(),this.$el.attr("transform",""),this.$el.empty(),this.itemControl.visible=!1,this.itemControl.render(),this.line_list_view.clear(),a=[];this.item_list.length>0;)a.push(this.item_list.remove(this.item_list.first()));return a},e.prototype.render=function(){return console.log("clone-control-view render"),this.$el.attr("opacity",0),this.itemControl.visible=!0,this.itemControl.render(),this.line_list_view.render()},e.prototype._setChildControlEvent=function(a){var b=this;return a.bind("onClick",function(a,c){return c.shiftKey&&(b.item_list.remove(a.model),c.preventDefault(),c.stopPropagation(),b.render(),0===b.item_list.length)?b.clear():void 0})},e.prototype._setControlViewEvent=function(a){var b=this;return a.bind("onMouseDown",function(a,c){return b.onEvent("onMouseDown",a,c)})},e.prototype.onEvent=function(a,b,c){if(b instanceof PositionControl||b instanceof ScaleControl||b instanceof RotateControl||b instanceof RotateAxisControl){if("onMouseDown"===a)return c.altKey?this._copyMode(b,c):(this.cancelEvent(c),this.attachDragEvent(b,c))}else if(b instanceof SvgElementView&&"onMouseDown"===a)return this.cancelEvent(c),this.itemControl.position_control.onMouseDown(c)},e.prototype._copyMode=function(a,b){return this.$el.show(),this.line_list_view.$el.show(),this.line_list_view.render(),this.itemControl.clear(),this.stopListening(),this.listenTo(this.item,"change",this.update),this.itemControl.visible=!0,this.itemControl.setItem(this.item),this.itemControl.render(),this.cancelEvent(b),this.attachCopyDragEvent(a,b)},e.prototype.cancelEvent=function(a){return a.preventDefault(),a.stopPropagation()},e.prototype.attachCopyDragEvent=function(a){var b,c=this;return this.mode="copy",this.$el.attr("opacity",.5),$(document).mousemove(a.onDragging),b=function(d){return c.mode="",a.onDrop&&a.onDrop(d),$(document).unbind("mousemove",a.onDragging),$(document).unbind("mouseup",b),c.initControls(c._copyItems()),c.cancelEvent(d)},$(document).mouseup(b)},e.prototype._copyItems=function(){var a,b,c,d=this;return b=this.item.getLocalMatrix(),a=[],c=this.item_list.sortBy(function(a){var b;return b=a.get("origin_model").el,$(b).index()}),_(c).each(function(c){var e;return e=c.getLocalMatrix(),c.setMatrix(b.multiply(e)),a.push(d.canvas.addElement(c.el.cloneNode(!0)))}),a},e.prototype.attachDragEvent=function(a){var b,c=this;return $(document).mousemove(a.onDragging),b=function(d){return a.onDrop&&a.onDrop(d),$(document).unbind("mousemove",a.onDragging),$(document).unbind("mouseup",b),c.cancelEvent(d)},$(document).mouseup(b)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.LinePositionControl=function(c){function e(){return this.render=b(this.render,this),this.onDrop=b(this.onDrop,this),this.onDragging=b(this.onDragging,this),this.onMouseDown=b(this.onMouseDown,this),this.isVisible=b(this.isVisible,this),this.show=b(this.show,this),this.hide=b(this.hide,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown"}},e.prototype.initialize=function(){return this.getItem=this.options.get_item,this.setStyle(),this.type=this.options.type},e.prototype.setStyle=function(){return $(this.el).attr({stroke:"black","stroke-width":"1",fill:"lightblue",opacity:.8,width:16,height:16,x:0,y:0})},e.prototype.hide=function(){return this.$el.hide()},e.prototype.show=function(){return this.$el.show()},e.prototype.isVisible=function(){return"none"!==this.$el.css("display")},e.prototype.onMouseDown=function(a){return this.pre_position=a,console.log("onMouseDown LinePositionControl"),$(document).mousemove(this.onDragging),$(document).mouseup(this.onDrop),a.preventDefault(),a.stopPropagation()},e.prototype.onDragging=function(a){var b,c;return c=SVGUtil.createPoint(a.offsetX,a.offsetY),c=c.matrixTransform(this.getItem().getCTM().inverse()),b={},b["x"+this.type]=c.x,b["y"+this.type]=c.y,this.getItem().attr(b)},e.prototype.onDrop=function(){return this.trigger("onDrop",this),$(document).unbind("mousemove",this.onDragging),$(document).unbind("mouseup",this.onDrop)},e.prototype.render=function(){var a,b,c;return this.isVisible()?(b=this.getItem(),a=b.el.getCTM(),this.x=parseInt($(b.el).attr("x"+this.type)),this.y=parseInt($(b.el).attr("y"+this.type)),c=SVGUtil.createPoint(this.x,this.y),c=c.matrixTransform(a),this.$el.attr({x:c.x-8,y:c.y-8})):void 0},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PositionControl=function(c){function e(){return this._getMovedPosition=b(this._getMovedPosition,this),this.movePosition=b(this.movePosition,this),this._getMoveMatrix=b(this._getMoveMatrix,this),this._getMoveCtmMatrix=b(this._getMoveCtmMatrix,this),this._getItemCoordPos=b(this._getItemCoordPos,this),this.onDrop=b(this.onDrop,this),this._snappingItem=b(this._snappingItem,this),this._snapPoints=b(this._snapPoints,this),this._getMovedControlPosition=b(this._getMovedControlPosition,this),this.onDragging=b(this.onDragging,this),this.onMouseDown=b(this.onMouseDown,this),this.render=b(this.render,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown"}},e.prototype.initialize=function(){return this.selectView=this.options.selectView,this.setStyle(),this.getItem=this.options.get_item},e.prototype.setStyle=function(){return $(this.el).attr("fill","none")},e.prototype.render=function(){var a;return a=this.getItem().getBBox(),this.$el.attr({width:a.width,height:a.height,x:a.x,y:a.y}),SVGUtil.setMatrixTransform(this.el,this.getItem().getCTM())},e.prototype.onMouseDown=function(a){return this.trigger("onMouseDown",this,a),this.pre_position=a,this.pre_matrix=this.getItem().getLocalMatrix(),this.pre_ctm=this.getItem().getCTM()},e.prototype.onDragging=function(a){var b;return b=this._getMovedControlPosition(a),a.altKey?(snap_line_view.clear(),snap_line_view.render(),this.movePosition(b)):this._snappingItem(a),this.trigger("onDragging",this,a)},e.prototype._getMovedControlPosition=function(a){var b;return b=this._getMovedPosition(a),a.shiftKey&&(Math.abs(b.x)>Math.abs(b.y)?b.y=0:b.x=0),b},e.prototype._snapPoints=function(a){var b,c;return c=this.getItem()._getMatrixBBoxPoints(this._getMoveCtmMatrix(a)),b=SVGUtil.createPoint((c[0].x+c[3].x)/2,(c[0].y+c[3].y)/2),c.push(b),c},e.prototype._snappingItem=function(a){var b,c;return c=this._getMovedControlPosition(a),b=Snapping.getSnap(this._snapPoints(c)),c.x=c.x-b.x,c.y=c.y-b.y,this.movePosition(c)},e.prototype.onDrop=function(){return this.trigger("onDrop",this)},e.prototype._getItemCoordPos=function(a){var b,c,d;return b=this.getItem(),d=SVGUtil.createPoint(a.x,a.y),c=b.getCTM().inverse(),c.e=0,c.f=0,d=d.matrixTransform(c)},e.prototype._getMoveCtmMatrix=function(a){var b;return b=this._getItemCoordPos(a),this.pre_ctm.translate(b.x,b.y)},e.prototype._getMoveMatrix=function(a){var b;return b=this._getItemCoordPos(a),this.pre_matrix.translate(b.x,b.y)},e.prototype.movePosition=function(a){return this.getItem().setMatrix(this._getMoveMatrix(a))},e.prototype._getMovedPosition=function(a){var b,c;return b=a.pageX-this.pre_position.pageX,c=a.pageY-this.pre_position.pageY,{x:b,y:c}},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.RotateAxisControl=function(c){function e(){return this.render_rotate_point=b(this.render_rotate_point,this),this.render_control_point=b(this.render_control_point,this),this.render=b(this.render,this),this.setRotate=b(this.setRotate,this),this.rotatePoint=b(this.rotatePoint,this),this.onDragging=b(this.onDragging,this),this.onMouseDown=b(this.onMouseDown,this),this.getRotateAxisPoint=b(this.getRotateAxisPoint,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown"}},e.prototype.initialize=function(){return this.rotate_point_el=this.options.rotate_point_el,this.getItem=this.options.get_item,this.setStyle(),this.rotate_point_view=new RotatePointControl({el:this.rotate_point_el}),this.rotate_point_view.bind("change",this.render)},e.prototype.setStyle=function(){return $(this.el).attr({stroke:"black","stroke-width":"1",fill:"lightblue",r:"8"})},e.prototype.getRotateAxisPoint=function(){return this.rotate_point_view.point},e.prototype.onMouseDown=function(a){var b;return this.trigger("onMouseDown",this,a),this._origin_matrix=this.getItem().getLocalMatrix(),this._origin_rotate_point=this.getRotateAxisPoint().matrixTransform(SvgCanvasBase.mainCanvas.getScreenCTM()),b=this.getItem().getCentorPoint(),this._origin_degree=this._radianToDegree(this._radian(b,this._origin_rotate_point))},e.prototype.onDragging=function(a){var b,c,d,e,f,g,h,i,j,k;if(e=SVGUtil.createPoint(a.pageX,a.pageY),b=this._radianToDegree(this._radian(e,this._origin_rotate_point)),g=b,h=15,a.shiftKey)for(c=parseInt(b/h),k=[h*c,h*(c-1)],d=i=0,j=k.length;j>i;d=++i)f=k[d],Math.abs(f-b)<10&&(g=f);return this.setRotate(g,this.rotatePoint())},e.prototype.rotatePoint=function(){return this.getRotateAxisPoint().matrixTransform(this._origin_matrix.inverse())},e.prototype.setRotate=function(a,b){var c,d;return d=d3.transform("matrix("+SVGUtil.toStringMatrix(this._origin_matrix.translate(b.x,b.y))+" )"),d.rotate=d.rotate+a-this._origin_degree,c=SVGUtil.TransformMatrix(d.toString()).translate(-b.x,-b.y),this.getItem().setMatrix(c)},e.prototype._radian=function(a,b){return Math.atan2(a.y-b.y,a.x-b.x)},e.prototype._radianToDegree=function(a){return a*(180/Math.PI)+90},e.prototype.render=function(){return this.render_control_point(),this.render_rotate_point()},e.prototype.render_control_point=function(){var a,b,c,d,e,f;return d=this.getRotateAxisPoint().matrixTransform(SvgCanvasBase.mainCanvas.getScreenCTM()),a=this.getItem().getCentorPoint(),c=Math.atan2(a.y-d.y,a.x-d.x),f=100*Math.sin(c),e=100*Math.cos(c),b=$(this.el),d=this.getRotateAxisPoint().matrixTransform(SvgCanvasBase.mainCanvas.getCTM()),b.attr("cx",d.x+e),b.attr("cy",d.y+f)},e.prototype.render_rotate_point=function(){return this.rotate_point_view.render()},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.RotateControl=function(c){function e(){return this.render_control_point_adove_item=b(this.render_control_point_adove_item,this),this.render=b(this.render,this),this.setRotate2=b(this.setRotate2,this),this.setRotate=b(this.setRotate,this),this.rotatePoint=b(this.rotatePoint,this),this.onDrop=b(this.onDrop,this),this.onDragging=b(this.onDragging,this),this.onMouseDown=b(this.onMouseDown,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown"}},e.prototype.initialize=function(){return this.rotate_point_el=this.options.rotate_point_el,this.getItem=this.options.get_item,this.setStyle()},e.prototype.setStyle=function(){return $(this.el).attr({stroke:"black","stroke-width":"1",fill:"lightgreen",r:"8"})},e.prototype.onMouseDown=function(a){return this.trigger("onMouseDown",this,a),this._origin_matrix=this.getItem().getLocalMatrix(),this._origin_rotate_point=this.getItem().getCentorPoint()},e.prototype.onDragging=function(a){var b,c,d,e,f,g,h,i,j,k;if(e=SVGUtil.createPoint(a.pageX,a.pageY),b=this._radianToDegree(this._radian(e,this._origin_rotate_point)),g=b,h=15,a.shiftKey)for(c=parseInt(b/h),k=[h*c,h*(c-1)],d=i=0,j=k.length;j>i;d=++i)f=k[d],Math.abs(f-b)<10&&(g=f);return this.setRotate(g,this.rotatePoint())},e.prototype.onDrop=function(){return console.log("RotateControl onDrop")},e.prototype.rotatePoint=function(){var a,b;return a=this.getItem().getBBox(),b=SVGUtil.createPoint(a.width/2+a.x,a.height/2+a.y)},e.prototype.setRotate=function(a,b){var c,d;return d=d3.transform("matrix("+SVGUtil.toStringMatrix(this._origin_matrix.translate(b.x,b.y))+" )"),d.rotate=a,c=SVGUtil.TransformMatrix(d.toString()).translate(-b.x,-b.y),this.getItem().setMatrix(c)},e.prototype.setRotate2=function(a){var b,c;return c=this.rotatePoint(),b=this._origin_matrix.translate(c.x,c.y).rotate(a).translate(-c.x,-c.y),this.getItem().setMatrix(b)},e.prototype._radian=function(a,b){return Math.atan2(a.y-b.y,a.x-b.x)},e.prototype._radianToDegree=function(a){return a*(180/Math.PI)+90},e.prototype.render=function(){return this.render_control_point_adove_item()},e.prototype.render_control_point_adove_item=function(){var a,b,c,d,e,f,g,h,i,j;return i=this.getItem().getBBox(),g=SVGUtil.SVG,c=SVGUtil.createTag("g"),d=g.createSVGPoint(),d.x=i.x+i.width/2,d.y=i.y+i.height/2,e=g.createSVGPoint(),e.x=0,e.y=-i.height/2,a=this.getItem().getCTM(),d=d.matrixTransform(a),a.e=0,a.f=0,j=SVGUtil.toD3Transform(a),h=SVGUtil.SVG.createSVGMatrix(),h=h.translate(j.translate[0],j.translate[1]),h=h.scaleNonUniform(j.scale[0],j.scale[1]),h=h.rotate(j.rotate),j.skew=0,c.setAttribute("transform",j.toString()),e=e.matrixTransform(c.getCTM()),f=g.createSVGPoint(),f.x=0,f.y=-30,j=SVGUtil.toD3Transform(a),j.scale[0]=1,j.scale[1]=1,j.skew=0,c.setAttribute("transform",j.toString()),f=f.matrixTransform(c.getCTM()),b=$(this.el),b.attr("cx",d.x+e.x+f.x),b.attr("cy",d.y+e.y+f.y)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.RotatePointControl=function(c){function e(){return this.render=b(this.render,this),this.onMouseDrop=b(this.onMouseDrop,this),this.onMouseMove=b(this.onMouseMove,this),this.onMouseDown=b(this.onMouseDown,this),this.setPoint=b(this.setPoint,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.point=SVGUtil.createPoint(250,250),this.setStyle()},e.prototype.events=function(){return{mousedown:"onMouseDown"}},e.prototype.setStyle=function(){return $(this.el).attr({stroke:"black","stroke-width":"3",fill:"white","fill-opacity":1,r:"6"})},e.prototype.setPoint=function(a,b){return this.point.x=a,this.point.y=b,this.trigger("change",this)},e.prototype.onMouseDown=function(a){return $(document).mousemove(this.onMouseMove),$(document).mouseup(this.onMouseDrop),a.preventDefault(),a.stopPropagation()},e.prototype.onMouseMove=function(a){var b,c;return b=SVGUtil.createPoint(a.offsetX,a.offsetY),c=Snapping.getSnap([b],!1),b=SVGUtil.createPoint(a.offsetX-c.x,a.offsetY-c.y),b=b.matrixTransform(SvgCanvasBase.mainCanvas.getCTM().inverse()),this.setPoint(b.x,b.y)},e.prototype.onMouseDrop=function(){return $(document).unbind("mousemove",this.onMouseMove),$(document).unbind("mouseup",this.onMouseDrop)},e.prototype.render=function(){var a;return a=this.point.matrixTransform(SvgCanvasBase.mainCanvas.getCTM()),this.$el.attr("cx",a.x),this.$el.attr("cy",a.y)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.ScaleControl=function(c){function e(){return this.renderForRect=b(this.renderForRect,this),this.renderForCircle=b(this.renderForCircle,this),this.render=b(this.render,this),this.onDrop=b(this.onDrop,this),this.setCenterScale=b(this.setCenterScale,this),this.setScale=b(this.setScale,this),this.getSnapPoint=b(this.getSnapPoint,this),this.onDragging=b(this.onDragging,this),this._getScaleMatrix=b(this._getScaleMatrix,this),this.onMouseDown=b(this.onMouseDown,this),this.saveValue=b(this.saveValue,this),this.controlPosition=b(this.controlPosition,this),this.fixedPosition=b(this.fixedPosition,this),this.yAxis=b(this.yAxis,this),this.xAxis=b(this.xAxis,this),this.setStyleForRect=b(this.setStyleForRect,this),this.setStyleForCircle=b(this.setStyleForCircle,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown"}},e.prototype.initialize=function(){return this.pos=this.options.pos,this.selectView=this.options.selectView,this.getItem=this.options.get_item,this.setStyle()},e.prototype.setStyle=function(){return $(this.el).attr("stroke-width","1"),$(this.el).attr("fill","lightblue"),this.setStyleForRect()},e.prototype.setStyleForCircle=function(){return this.mark_size=8,$(this.el).attr("stroke","black"),$(this.el).attr("fill-opacity","0.5"),$(this.el).attr("r",this.mark_size)},e.prototype.setStyleForRect=function(){return this.mark_size=10,$(this.el).attr("stroke","blue"),$(this.el).attr("stroke-width","0.5"),$(this.el).attr("fill-opacity","0.7"),$(this.el).attr("stroke","blue"),$(this.el).attr("x",0),$(this.el).attr("y",0),$(this.el).attr("width",this.mark_size),$(this.el).attr("height",this.mark_size)},e.prototype.xAxis=function(){return this.getItem().getPosition({x:this.pos.x,y:-1*this.pos.y})
},e.prototype.yAxis=function(){return this.getItem().getPosition({x:-1*this.pos.x,y:this.pos.y})},e.prototype.fixedPosition=function(){return this.getItem().getPosition({x:-1*this.pos.x,y:-1*this.pos.y})},e.prototype.controlPosition=function(){return this.getItem().getPosition(this.pos)},e.prototype.saveValue=function(){var a;return this._pre_vec_x=this._getVecPoint(this.controlPosition(),this.xAxis()),this._pre_vec_y=this._getVecPoint(this.controlPosition(),this.yAxis()),a=this.getItem(),this.pre_fixed_point=this.fixedPosition(),this.pre_control_point=this.controlPosition(),this.pre_center_point=a.getCentorPoint(),this._pre_vec=this._getVecPoint(this.fixedPosition(),this.controlPosition()),this.origin_ctm=a.getLocalMatrix(),this.origin_bbox=a.getBBox(),this.origin_attribute={width:$(a.el).attr("width"),height:$(a.el).attr("height"),r:$(a.el).attr("r"),rx:$(a.el).attr("rx"),ry:$(a.el).attr("ry")}},e.prototype.onMouseDown=function(a){return this.trigger("onMouseDown",this,a),this.saveValue()},e.prototype._getVecPoint=function(a,b){return SVGUtil.createPoint(b.x-a.x,b.y-a.y)},e.prototype._getScaleMatrix=function(){var a;return a=SVGUtil.SVG.createSVGMatrix(),a.a=this._pre_vec_y.x,a.b=this._pre_vec_y.y,a.c=this._pre_vec_x.x,a.d=this._pre_vec_x.y,a},e.prototype.onDragging=function(a){var b,c,d,e,f,g;return e=this.getSnapPoint(a),b=this._getVecPoint(this.pre_fixed_point,e),c=this._getScaleMatrix(),d=b.matrixTransform(c.inverse()),f=-d.x,g=-d.y,a.shiftKey&&(Math.abs(f)>Math.abs(g)?g=f:f=g),a.altKey?this.setCenterScale(2*f-1,2*g-1):this.setScale(f,g)},e.prototype.getSnapPoint=function(a){var b,c,d;return d=[],b=SVGUtil.createPoint(a.offsetX,a.offsetY),c=Snapping.getSnap([b]),SVGUtil.createPoint(b.x-c.x,b.y-c.y)},e.prototype.setScale=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return e=this.getItem(),"rect"===e.el.tagName?(q=Math.abs(this.origin_attribute.width*a),r=Math.abs(this.origin_attribute.height*b),l=q-this.origin_attribute.width,k=r-this.origin_attribute.height,e.attr({width:q,height:r}),-1!==this.pos.x&&(l=0),-1!==this.pos.y&&(k=0),f=this.origin_ctm.translate(-l,-k)):"circle"===e.el.tagName?(q=Math.abs(this.origin_attribute.r*a),r=Math.abs(this.origin_attribute.r*b),this instanceof ScaleOneAxisControl||(r=q),o=q-this.origin_attribute.r,p=r-this.origin_attribute.r,this instanceof ScaleOneAxisControl&&"y"===this.axis_type?e.attr({r:r}):e.attr({r:q}),-1!==this.pos.x&&(o=-o),-1!==this.pos.y&&(p=-p),f=this.origin_ctm.translate(-o,-p)):"ellipse"===e.el.tagName?(q=Math.abs(this.origin_attribute.rx*a),r=Math.abs(this.origin_attribute.ry*b),o=q-this.origin_attribute.rx,p=r-this.origin_attribute.ry,e.attr({rx:q,ry:r}),-1!==this.pos.x&&(o=-o),-1!==this.pos.y&&(p=-p),f=this.origin_ctm.translate(-o,-p)):(d=this.origin_bbox.width,c=this.origin_bbox.height,i=this.origin_bbox.x*a-this.origin_bbox.x,j=this.origin_bbox.y*b-this.origin_bbox.y,h=d*a-d,g=c*b-c,m=-1!==this.pos.x?i:h+i,n=-1!==this.pos.y?j:g+j,f=this.origin_ctm.translate(-m,-n),f=f.scaleNonUniform(a,b)),e.setMatrix(f)},e.prototype.setCenterScale=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return e=this.getItem(),"rect"===e.el.tagName?(q=Math.abs(this.origin_attribute.width*a),r=Math.abs(this.origin_attribute.height*b),l=q-this.origin_attribute.width,k=r-this.origin_attribute.height,e.attr({width:q,height:r}),f=this.origin_ctm.translate(-l/2,-k/2)):"circle"===e.el.tagName?(q=Math.abs(this.origin_attribute.r*a),r=Math.abs(this.origin_attribute.r*b),o=q-this.origin_attribute.r,p=r-this.origin_attribute.r,e.attr({r:q}),f=this.origin_ctm):"ellipse"===e.el.tagName?(q=Math.abs(this.origin_attribute.rx*a),r=Math.abs(this.origin_attribute.ry*b),o=q-this.origin_attribute.rx,p=r-this.origin_attribute.ry,e.attr({rx:q,ry:r}),f=this.origin_ctm):(d=this.origin_bbox.width,c=this.origin_bbox.height,i=this.origin_bbox.x*a-this.origin_bbox.x,j=this.origin_bbox.y*b-this.origin_bbox.y,h=d*a-d,g=c*b-c,n=g/2+j,m=h/2+i,f=this.origin_ctm.translate(-m,-n),f=f.scaleNonUniform(a,b)),e.setMatrix(f)},e.prototype.onDrop=function(){return console.log("ScaleControl onDrop")},e.prototype.render=function(){return this.renderForRect()},e.prototype.renderForCircle=function(){return $(this.el).attr("cx",this.controlPosition().x),$(this.el).attr("cy",this.controlPosition().y)},e.prototype.renderForRect=function(){var a,b;return a=this.controlPosition().x,b=this.controlPosition().y,$(this.el).attr("x",a-this.mark_size/2),$(this.el).attr("y",b-this.mark_size/2)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.ScaleControlSet=function(c){function e(){return this.createScaleControl=b(this.createScaleControl,this),this.createScaleOneAxixControl=b(this.createScaleOneAxixControl,this),this.show=b(this.show,this),this.hide=b(this.hide,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m;this.selectView=this.options.selectView,this.getItem=this.options.get_item,this.scale_controls=[],i={left:-1,center:0,right:1},b={top:-1,center:0,bottom:1},this.positions={};for(h in i){e=i[h];for(a in b)d=b[a],g={name:h+"-"+a,pos:{x:e,y:d}},this.positions[g.name]=g}for(h in i){e=i[h];for(a in b)d=b[a],("center"!==h||"center"!==a)&&("center"===h||"center"===a?this.scale_controls.push(this.createScaleOneAxixControl(h+"-"+a)):this.scale_controls.push(this.createScaleControl(h+"-"+a)))}for(l=this.scale_controls,m=[],c=j=0,k=l.length;k>j;c=++j)f=l[c],m.push($(this.el).append(f.el));return m},e.prototype.hide=function(){return this.$el.hide()},e.prototype.show=function(){return this.$el.show()},e.prototype.render=function(){return _.each(this.scale_controls,function(a){return a.render()})},e.prototype.createScaleOneAxixControl=function(a){var b,c;return b=this.positions[a],c=0===b.pos.x?"y":"x",new ScaleOneAxisControl({selectView:this.selectView,el:SVGUtil.createTag("rect"),pos:b.pos,axis_type:c,get_item:this.getItem})},e.prototype.createScaleControl=function(a){var b;return b=this.positions[a],new ScaleControl({selectView:this.selectView,el:SVGUtil.createTag("rect"),pos:b.pos,get_item:this.getItem})},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.ScaleOneAxisControl=function(c){function e(){return this.onDragging=b(this.onDragging,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.pos=this.options.pos,this.selectView=this.options.selectView,this.axis_type=this.options.axis_type,this.getItem=this.options.get_item,this.setStyle()},e.prototype._getDotVec=function(a,b){return VectorUtil.dot(a,b)},e.prototype._getDist=function(a){return Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2))},e.prototype.onDragging=function(a){var b,c,d,e,f;return d=this.getSnapPoint(a),this.control_vec=this._getVecPoint(this.pre_fixed_point,d),b=this._getDist(this._pre_vec),c=this._getDotVec(this._pre_vec,this.control_vec)/(b*b),"x"===this.axis_type?(e=c,f=1):(e=1,f=c),a.altKey?this.setCenterScale(2*e-1,2*f-1):this.setScale(e,f)},e}(ScaleControl)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.ItemControl=function(c){function e(){return this.clear=b(this.clear,this),this.setItem=b(this.setItem,this),this._removeLineView=b(this._removeLineView,this),this._createLineView=b(this._createLineView,this),this.onModelChange=b(this.onModelChange,this),this.isSelected=b(this.isSelected,this),this.getItem=b(this.getItem,this),this._appendElement=b(this._appendElement,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){var a,b,c,d,e=this;for(this.manager=this.options.manager,this.position_control=new PositionControl({selectView:this,el:this._appendElement("rect"),get_item:this.getItem}),this.scale_control_set=new ScaleControlSet({selectView:this,el:this._appendElement("g"),get_item:this.getItem}),this.rotate_control=new RotateControl({el:this._appendElement("circle"),get_item:this.getItem}),this.rotate_axis_control=new RotateAxisControl({el:this._appendElement("circle"),rotate_point_el:this._appendElement("circle"),get_item:this.getItem}),this.line_position_control1=new LinePositionControl({el:this._appendElement("rect"),type:"1",get_item:this.getItem}),this.line_position_control2=new LinePositionControl({el:this._appendElement("rect"),type:"2",get_item:this.getItem}),d=_.union([this.position_control,this.rotate_control,this.rotate_axis_control],this.scale_control_set.scale_controls),b=0,c=d.length;c>b;b++)a=d[b],a.bind("onMouseDown",function(a,b){return e.manager.onEvent("onMouseDown",a,b)});return this.position_control.bind("onDragging",function(a,b){return e.manager.onEvent("onDragging",a,b)}),this.visible=!1,this.render()},e.prototype._appendElement=function(a){var b;return b=SVGUtil.createTag(a),this.$el.append(b),b},e.prototype.getItem=function(){return this.selectitem},e.prototype.isSelected=function(){return null!=this.selectitem},e.prototype.onModelChange=function(){return this.render()},e.prototype._createLineView=function(a){var b,c;return c=$("#select-line-views"),b=SVGUtil.createTag("path"),$(c).append(b),new SelectLineView({el:b,model:a})},e.prototype._removeLineView=function(){return this.select_line_view&&this.select_line_view.remove(),this.select_line_view=void 0},e.prototype.setItem=function(a){return this.selectitem&&this.selectitem.unbind("change",this.onModelChange,this),this.selectitem=a,this._removeLineView(),this.select_line_view=this._createLineView(a),this.select_line_view.stopListening(),this.selectitem.bind("change",this.onModelChange,this)},e.prototype.clear=function(){return this._removeLineView(),this.selectitem&&this.selectitem.unbind("change",this.onModelChange,this),this.selectitem=void 0,this.visible=!1,this.render()},e.prototype.render=function(){return $(this.el).attr("display",this.visible?"":"none"),this.selectitem?(this.select_line_view.render(),this.position_control.render(),this.rotate_control.render(),this.rotate_axis_control.render(),this.scale_control_set.render(),this.selectitem.el instanceof SVGLineElement?(this.line_position_control1.show(),this.line_position_control2.show(),this.line_position_control1.render(),this.line_position_control2.render(),this.scale_control_set.hide()):(this.line_position_control1.hide(),this.line_position_control2.hide(),this.scale_control_set.show()),this.trigger("render",this)):void 0},e}(Backbone.View)}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.ElementControlMode=function(){function b(b){this._onSvgElementView=a(this._onSvgElementView,this),this._getRegionContainItems=a(this._getRegionContainItems,this),this._onRegionDrop=a(this._onRegionDrop,this),this._onSvgCanvas=a(this._onSvgCanvas,this),this.onEvent=a(this.onEvent,this),this.getControl=a(this.getControl,this),_.extend(this,Backbone.Events),this.maneger=b,this.regionView=new SelectRegionControlView({el:$("#select-control-region-view"),canvas:this.maneger.canvas})}return b.prototype.getControl=function(){return this.maneger.getControl()},b.prototype.onEvent=function(a,b){return b instanceof SvgElementView?this._onSvgElementView.apply(this,arguments):b instanceof SvgCanvas?this._onSvgCanvas.apply(this,arguments):void 0},b.prototype._onSvgCanvas=function(a,b,c){return console.log("_onSvgCanvas",this,arguments),"onMouseDown"!==a||c.altKey?void 0:(this.regionView.canvas=this.maneger.getCanvas(),this.listenToOnce(this.regionView,"onRegionDrop",this._onRegionDrop),this.regionView.startSelectRegion(c))},b.prototype._onRegionDrop=function(){var a,b;return a=this._getRegionContainItems(this.maneger.canvas.getItems(),this.regionView),b=this.getControl(),b.clear(),a.length>0?b.initControls(a):void 0},b.prototype._getRegionContainItems=function(a,b){var c;return c=a.filter(function(a){return!a.isLocked()}),c.filter(function(a){return _.any(a.getBBoxPoints(),function(a){return b.isContainPoint(a)})})},b.prototype._onSvgElementView=function(a,b,c){var d;if(d=this.getControl(),"onMouseDown"===a){if(this.cancelEvent(c),!c.shiftKey)return d.exists(b.model)||(d.clear(),d.addItem(b.model)),d.getControl().position_control.onMouseDown(c);if(!d.exists(b.model))return d.addItem(b.model)}else if("onClick"===a)return this.cancelEvent(c)},b.prototype.cancelEvent=function(a){return a.preventDefault(),a.stopPropagation()},b}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.TextEditMode=function(){function b(b){this._unbindTextEditor=a(this._unbindTextEditor,this),this.onEvent=a(this.onEvent,this),this.maneger=b,this.text_editor=new SvgTextEditor($("#text-editor-view")[0],void 0),this.text_editor.setOnDisable(this._unbindTextEditor)}return b.prototype.onEvent=function(a,b,c){if(console.log("TextEditMode",arguments),b instanceof SvgElementView){if("onClick"===a&&b.model.el instanceof SVGTextElement)return this.text_editor.setTextElement(b.model.el),this.text_editor.bindEvent(),this.text_editor.onClickEvent(c),this.cancelEvent(c)}else if(b instanceof SvgCanvas&&"onClick"===a)return this._unbindTextEditor(),this.maneger.setMode("control")},b.prototype.cancelEvent=function(a){return a.preventDefault(),a.stopPropagation()},b.prototype._unbindTextEditor=function(){return this.text_editor.unbindClickEvent()},b}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.PathEditMode=function(){function b(b){this.onEvent=a(this.onEvent,this),this.maneger=b}return b.prototype.onEvent=function(a,b){return b instanceof SvgElementView&&"onClick"===a&&b.model.el instanceof SVGPathElement?svgPathControl.setItem(b.model):void 0},b.prototype.cancelEvent=function(a){return a.preventDefault(),a.stopPropagation()},b}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.EventManager=function(){function b(){this.setCanvas=a(this.setCanvas,this),this.reset=a(this.reset,this),this.onEvent=a(this.onEvent,this),this.getControl=a(this.getControl,this),this.setMode=a(this.setMode,this),this.setControl=a(this.setControl,this),this.getCanvas=a(this.getCanvas,this),_.extend(this,Backbone.Events),this.modes={control:new ElementControlMode(this),text:new TextEditMode(this),path:new PathEditMode(this)},this.mode=null,this.selected_item=null}return b.prototype.getCanvas=function(){return this.canvas},b.prototype.setControl=function(a){return this._control=a},b.prototype.setMode=function(a){var b;return b=this.modes[a],b?this.mode=b:void 0},b.prototype.getControl=function(){return this._control},b.prototype.onEvent=function(a,b,c,d){return this.mode.onEvent(a,b,c,d)},b.prototype.reset=function(){},b.prototype.setCanvas=function(a){return this.canvas=a,this.mode=new ElementControlMode(this)},b.prototype.cancelEvent=function(a){return a.preventDefault(),a.stopPropagation()},b}()}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.InspectorListView=function(c){function e(){return this.sortByIndex=b(this.sortByIndex,this),this.removeItem=b(this.removeItem,this),this.addItem=b(this.addItem,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.tagName="ul",e.prototype.initialize=function(){return this.$el.attr("class","unstyled"),this.item_list=this.options.item_list,this.control=this.options.control,this.listenTo(this.item_list,"add",this.addItem),this.listenTo(this.item_list,"remove",this.removeItem),this.inspector_views=[]},e.prototype.addItem=function(a){var b;return b=new InspectorView({model:a,control:this.control}),this.inspector_views.push(b),this.$el.prepend(b.el)},e.prototype.removeItem=function(a){var b,c;return c=_(this.inspector_views).find(function(b){return b.model===a}),b=this.inspector_views.indexOf(c),this.inspector_views.splice(b,1)},e.prototype.sortByIndex=function(){var a,b=this;return a=_(this.inspector_views).sortBy(function(a){return $(a.model.el).index()}),a.forEach(function(a){return b.$el.prepend(a.el)})},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.InspectorView=function(c){function e(){return this.render=b(this.render,this),this.onClickVisible=b(this.onClickVisible,this),this.onClickLock=b(this.onClickLock,this),this.onClickSelect=b(this.onClickSelect,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.tagName="li",e.prototype.initialize=function(){return this.control=this.options.control,this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model,"change",this.render),this.render()},e.prototype.events=function(){return{"click .lock-element":"onClickLock","click .select-element":"onClickSelect","click .visible-element":"onClickVisible"}},e.prototype.template=_.template('        <div style="padding:5px;border-bottom:1px solid #ccc">            <div style="border:1px solid black;margin:0px 5px;float:left;height:15px;width:15px;background-color:{{color}}" class="select-element"></div>            lock: <input class="lock-element" type="checkbox" {{locked}}/>            visible: <input class="visible-element" type="checkbox" {{visible}}/>            {{element_type}}        </div>    '),e.prototype.onClickSelect=function(){return this.model.isSelected()?this.control.removeItem(this.model):this.control.addItem(this.model)},e.prototype.onClickLock=function(){return this.model.toggleLock()},e.prototype.onClickVisible=function(){return this.model.isVisibled()?this.model.hide():this.model.show()},e.prototype.render=function(){var a,b,c;return this.$el.empty(),b=this.model.isLocked()?"checked":"",a=this.model.isSelected()?"skyblue":"white",c=this.model.isVisibled()?"checked":"",this.$el.html(this.template({element_type:this.model.el.constructor.name,locked:b,color:a,visible:c})),this},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgCurveView=function(c){function e(){return this.render=b(this.render,this),this.toPathData=b(this.toPathData,this),this.onMouseLeave=b(this.onMouseLeave,this),this.onMouseOver=b(this.onMouseOver,this),this.onMouseDown=b(this.onMouseDown,this),this._cancelEvent=b(this._cancelEvent,this),this.onClick=b(this.onClick,this),this.setDefalutStyle=b(this.setDefalutStyle,this),this.setStyle=b(this.setStyle,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.curve=this.options.curve,this.item=this.options.item,this.pathControl=this.options.pathControl,this.setStyle(),this.setDefalutStyle(),this.render()},e.prototype.events=function(){return{click:"onClick",mousedown:"onMouseDown",mouseover:"onMouseOver",mouseleave:"onMouseLeave"}},e.prototype.setStyle=function(){return $(this.el).attr({fill:"none","stroke-width":"3"})},e.prototype.setDefalutStyle=function(){return $(this.el).attr({stroke:"blue","stroke-opacity":"0"})},e.prototype.onClick=function(a){var b,c,d;return a.shiftKey?(c=this.item.getScreenCTM(),d=SVGUtil.createPoint(a.pageX,a.pageY),d=d.matrixTransform(c.inverse()),b=this.curve.getNearestLocation(d),a.altKey?b.split():b.divide(),this.pathControl.refresh(),this._cancelEvent(a)):void 0},e.prototype._cancelEvent=function(a){return a.preventDefault(),a.stopPropagation()},e.prototype.onMouseDown=function(a){return this._cancelEvent(a)},e.prototype.onMouseOver=function(a){var b,c;return $(this.el).attr({stroke:"red","stroke-opacity":"1"}),b=this.item.getScreenCTM(),c=SVGUtil.createPoint(a.pageX,a.pageY),c=c.matrixTransform(b.inverse())},e.prototype.onMouseLeave=function(){return this.setDefalutStyle()},e.prototype.toPathData=function(){var a,b,c,d,e,f,g,h,i,j,k;return h=[],j=!1,f=Math.pow(10,5),b=this.item.el.getCTM(),e=this.item.el.getCTM(),e.e=0,e.f=0,g=function(a){return Math.round(a*f)/f},i=function(a){return g(a.x)+","+g(a.y)},c=function(a){var c;return c=SVGUtil.createPoint(a.x,a.y),c.matrixTransform(b)},d=function(a){var b;return b=SVGUtil.createPoint(a.x,a.y),b.matrixTransform(e)},a=function(a,b){var e,f,g,j,k;return j=c(a._point),k=c(b._point),j=new paper.Point(j.x,j.y),k=new paper.Point(k.x,k.y),f=d(a._handleOut),g=d(b._handleIn),f=new paper.Point(f.x,f.y),g=new paper.Point(g.x,g.y),f.isZero()&&g.isZero()?h.push("L"+i(k)):(e=k.subtract(j),h.push("c"+i(f)+" "+i(e.add(g))+" "+i(e)))},k=c(this.curve.getSegment1()._point),h.push("M"+k.x+", "+k.y),a(this.curve.getSegment1(),this.curve.getSegment2(),!1),h.join("")},e.prototype.render=function(){return this.$el.attr("d",this.toPathData())},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgPathControlView=function(c){function e(){return this.createRect=b(this.createRect,this),this.createPoint=b(this.createPoint,this),this.setItem=b(this.setItem,this),this.unbindItem=b(this.unbindItem,this),this.refresh=b(this.refresh,this),this.updateItemPath=b(this.updateItemPath,this),this.clear=b(this.clear,this),this.render=b(this.render,this),this.clearView=b(this.clearView,this),this.moveSelectSegments=b(this.moveSelectSegments,this),this.savePoint=b(this.savePoint,this),this._setupControlView=b(this._setupControlView,this),this.createViews=b(this.createViews,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){var a,b;return b=document.getElementById("container"),a=document.createElement("canvas"),$(a).hide(),b.appendChild(a),this.paper_score=new paper.PaperScope,this.paper_score.setup(a),this.path=new paper.CompoundPath,this.path.strokeColor="#268BD2",this.path.strokeWidth=2,this.path.fillColor="#B5E1FF",this.path.opacity=.75,this.path.fullySelected=!0,this._control_views=[],this._segments=[]},e.prototype.createViews=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(this.clearView(),this._segments=[],n=this.path._children,h=0,k=n.length;k>h;h++){for(a=n[h],d=[],this._pre_curve_control=null,o=a._segments,i=0,l=o.length;l>i;i++)f=o[i],c=this.createView(f),d.push(c),this._segments.push(c.segment);for(e=_(d).last(),p=[e],g=function(a){return d[0].segment.on("change",function(){return a.curveControl.render()})},j=0,m=p.length;m>j;j++)b=p[j],g(b)}return this._setupControlView()},e.prototype._setupControlView=function(){var a,b,c,d;return d=SVGUtil.createTag("g"),b=SVGUtil.createTag("g"),a=SVGUtil.createTag("g"),c=SVGUtil.createTag("g"),this._control_views.forEach(function(d){return d instanceof SvgSegmentHandleControl?$(c).append(d.el):d instanceof SvgSegmentPointControl?$(a).append(d.el):d instanceof SvgCurveView?$(b).append(d.el):$(group).append(d.el)}),this._control_views.forEach(function(a){return a instanceof SvgSegmentPointControl&&a.createHandleLine(d),a.render()}),this.$el.append(d),this.$el.append(b),this.$el.append(c),this.$el.append(a)},e.prototype.createView=function(a){var b,c,d,e,f,g,h,i,j=this;return i=new PathSegmentAdapeter,i.init(a),c=a.getCurve(),d=null,h=this._pre_curve_control,c&&(e=SVGUtil.createTag("path"),d=new SvgCurveView({pathControl:this,el:e,item:this.item,curve:c}),this._pre_curve_control=d,this._control_views.push(d)),e=this.createRect(0,0),b=new SvgSegmentPointControl({pathControl:this,el:e,item:this.item,curveControl:d,segment:i,getPoint:function(){return i.getPoint()}}),this._control_views.push(b),e=this.createPoint(0,0),g=new SvgSegmentHandleControl({pathControl:this,el:e,item:this.item,segment:i,getPoint:function(){return i.getHandleOut()}}),this._control_views.push(g),e=this.createPoint(0,0),f=new SvgSegmentHandleControl({pathControl:this,el:e,item:this.item,segment:i,getPoint:function(){return i.getHandleIn()}}),this._control_views.push(f),i.on("change",function(){return j.updateItemPath(),f.render(),g.render(),b.render(),d&&d.render(),h?h.render():void 0}),b},e.prototype.savePoint=function(){var a,b,c,d,e;for(d=this._segments,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.getPoint().savePoint());return e},e.prototype.moveSelectSegments=function(a){var b,c,d,e,f,g,h,i,j;for(i=this._segments,j=[],g=0,h=i.length;h>g;g++)d=i[g],d.isSelected()?(b=d.getPoint(),c=b.getSavePoint(),e=c.x+a.x,f=c.y+a.y,j.push(b.setPoint(e,f))):j.push(void 0);return j},e.prototype.clearView=function(){return this._control_views.forEach(function(a){return a.remove()}),this._control_views=[],this.clear()},e.prototype.render=function(){return this._control_views.forEach(function(a){return a.render()})},e.prototype.clear=function(){return this.$el.empty()},e.prototype.updateItemPath=function(){return this.item.attr("d",this.path.getPathData())},e.prototype.refresh=function(){return this.updateItemPath(),this.createViews()},e.prototype.unbindItem=function(){return this.stopListening(),this.clearView()},e.prototype.setItem=function(a){return this.item=a,this.path.setPathData($(this.item.el).attr("d")),this.listenTo(a,"change:matrix",this.render),this.createViews()},e.prototype.createPoint=function(a,b){var c;return c=SVGUtil.createTag("circle"),$(c).attr({cx:a,cy:b,stroke:"black","stroke-width":"1",fill:"lightgreen",r:"8"}),c},e.prototype.createRect=function(a,b){var c;return c=SVGUtil.createTag("rect"),$(c).attr({x:a-8,y:b-8,stroke:"black","stroke-width":"1",fill:"lightblue",width:"16",height:"16"})},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgSegmentPointControl=function(c){function e(){return this.remove=b(this.remove,this),this.renderHandleLine=b(this.renderHandleLine,this),this.render=b(this.render,this),this.onMouseDropHandle=b(this.onMouseDropHandle,this),this.onMouseDrop=b(this.onMouseDrop,this),this._getMovedPosition=b(this._getMovedPosition,this),this.onMouseMove=b(this.onMouseMove,this),this.onMouseMoveHandle=b(this.onMouseMoveHandle,this),this._itemMatrixPos=b(this._itemMatrixPos,this),this.onMouseDown=b(this.onMouseDown,this),this.onClick=b(this.onClick,this),this.setStyle=b(this.setStyle,this),this.onMouseLeave=b(this.onMouseLeave,this),this.onMouseOver=b(this.onMouseOver,this),this._createLine=b(this._createLine,this),this.createHandleLine=b(this.createHandleLine,this),this._init=b(this._init,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown",click:"onClick",mouseover:"onMouseOver",mouseleave:"onMouseLeave"}},e.prototype.initialize=function(){return this._init()},e.prototype._init=function(){return this.segment=this.options.segment,this.item=this.options.item,this.getPoint=this.options.getPoint,this.pathControl=this.options.pathControl,this.curveControl=this.options.curveControl,this.setStyle()},e.prototype.createHandleLine=function(a){return this.handleInLine=this._createLine(a),this.handleOutLine=this._createLine(a)},e.prototype._createLine=function(a){var b;return b=SVGUtil.createTag("line"),$(a).append(b),$(b).attr({"stroke-width":"1",stroke:"blue"})},e.prototype.onMouseOver=function(){return $(this.el).attr({"stroke-width":"3"})},e.prototype.onMouseLeave=function(){return $(this.el).attr({"stroke-width":"1"})},e.prototype.setStyle=function(){return $(this.el).attr({stroke:"black","stroke-width":"1",fill:"white",width:"12",height:"12"})},e.prototype.onClick=function(a){return a.shiftKey&&this.segment.setSelected(!this.segment.isSelected()),a.altKey?a.shiftKey?(this.segment.remove(),this.pathControl.refresh()):this.segment.setLinear():void 0},e.prototype.onMouseDown=function(a){return this.pre_position=a,this.pathControl.savePoint(),a.altKey?($(document).mousemove(this.onMouseMoveHandle),$(document).mouseup(this.onMouseDropHandle)):($(document).mousemove(this.onMouseMove),$(document).mouseup(this.onMouseDrop)),a.preventDefault(),a.stopPropagation()},e.prototype._itemMatrixPos=function(a){var b,c;return c=SVGUtil.createPoint(a.x,a.y),b=this.item.getCTM(),b.e=0,b.f=0,c.matrixTransform(b.inverse())},e.prototype.onMouseMoveHandle=function(a){var b,c,d;return b=this._getMovedPosition(a),b=this._itemMatrixPos(b),c=b.x,d=b.y,this.segment.getHandleOut().setPoint(c,d),this.segment.getHandleIn().setPoint(-c,-d)},e.prototype.onMouseMove=function(a){var b,c,d,e,f;return c=this._getMovedPosition(a),a.shiftKey&&(Math.abs(c.x)>Math.abs(c.y)?c.y=0:c.x=0),b=this.getPoint(),c=this._itemMatrixPos(c),e=c.x,f=c.y,this.segment.isSelected()||(b=this.segment.getPoint(),d=b.getSavePoint(),e=d.x+c.x,f=d.y+c.y,b.setPoint(e,f)),this.pathControl.moveSelectSegments(c)},e.prototype._getMovedPosition=function(a){var b,c;return b=a.pageX-this.pre_position.pageX,c=a.pageY-this.pre_position.pageY,{x:b,y:c}},e.prototype.onMouseDrop=function(){return $(document).unbind("mousemove",this.onMouseMove),$(document).unbind("mouseup",this.onMouseDrop)},e.prototype.onMouseDropHandle=function(){return $(document).unbind("mousemove",this.onMouseMoveHandle),$(document).unbind("mouseup",this.onMouseDropHandle)},e.prototype.render=function(){var a,b;return a=this.getPoint(),b=SVGUtil.createPoint(a.getX(),a.getY()),a=b.matrixTransform(this.item.getCTM()),this.segment.isSelected()?this.$el.attr({fill:"blue"}):this.$el.attr({fill:"white"}),this.$el.attr({x:a.x-6,y:a.y-6}),this.renderHandleLine(this.segment.getHandleOut(),this.handleOutLine),this.renderHandleLine(this.segment.getHandleIn(),this.handleInLine)},e.prototype.renderHandleLine=function(a,b){var c,d,e,f;return e=this.segment.getPoint().getX(),f=this.segment.getPoint().getY(),d=SVGUtil.createPoint(e+a.getX(),f+a.getY()),d=d.matrixTransform(this.item.getCTM()),c=SVGUtil.createPoint(e,f),c=c.matrixTransform(this.item.getCTM()),$(b).attr({x1:d.x,y1:d.y,x2:c.x,y2:c.y})},e.prototype.remove=function(){return e.__super__.remove.call(this),this.handleInLine.remove(),this.handleOutLine.remove()},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgSegmentHandleControl=function(c){function e(){return this.render=b(this.render,this),this.setStyle=b(this.setStyle,this),this.onMouseMove=b(this.onMouseMove,this),this.onClick=b(this.onClick,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this._init()
},e.prototype.onClick=function(a){return a.altKey?this.getPoint().setPoint(0,0):void 0},e.prototype.onMouseMove=function(a){var b,c,d,e;return c=this._getMovedPosition(a),b=this.getPoint(),c=this._itemMatrixPos(c),d=b.getX()+c.x,e=b.getY()+c.y,b.setPoint(d,e),a.shiftKey&&(b===this.segment.getHandleIn()?this.segment.getHandleOut().setPoint(-d,-e):b===this.segment.getHandleOut()&&this.segment.getHandleIn().setPoint(-d,-e)),this.pre_position=a},e.prototype.setStyle=function(){return $(this.el).attr({stroke:"blue","stroke-width":"1",fill:"white",r:"6"})},e.prototype.render=function(){var a,b,c,d;return c=this.segment.getPoint().getX(),d=this.segment.getPoint().getY(),a=this.getPoint(),b=SVGUtil.createPoint(c+a.getX(),d+a.getY()),b=b.matrixTransform(this.item.getCTM()),this.$el.attr({cx:b.x,cy:b.y})},e}(SvgSegmentPointControl)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PropertyEditSetView=function(c){function e(){return this.clear=b(this.clear,this),this.bindElement=b(this.bindElement,this),this.render=b(this.render,this),this._init_view=b(this._init_view,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.prop_views={},this.model=new PropertyEdit,this.attrs=["id","class","x","y","width","height","transform","fill","fill-spe","fill-opacity","stroke","stroke-spe","stroke-opacity","stroke-width","stroke-linecap","stroke-dasharray","stroke-offset","style","filter","opacity","xlink:href","mask","r","rx","ry","writing-mode","x1","x2","y1","y2","fill-rule","d","font-size","font-family","text-anchor","visibility"],this._init_view()},e.prototype._init_view=function(){var a,b,c,d,e,f,g;for(f=this.attrs,g=[],d=0,e=f.length;e>d;d++)a=f[d],c="text",b=new PropertyEditView({inputType:c,attrName:a,model:this.model}),this.prop_views[a]=b,g.push(this.$el.append(b.el));return g},e.prototype.render=function(){var a,b,c,d;this.model.updateElement(),c=this.prop_views,d=[];for(a in c)b=c[a],d.push(b.render());return d},e.prototype.bindElement=function(a){return this.stopListening(),this.listen_model=a,this.model.bindElement(a),this.listenTo(a,"change",this.render),this.render()},e.prototype.clear=function(){var a,b,c,d;this.stopListening(),this.model.unbindElement(),c=this.prop_views,d=[];for(a in c)b=c[a],d.push(b.clear());return d},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PropertyEditView=function(c){function e(){return this.clear=b(this.clear,this),this.render=b(this.render,this),this.initElement=b(this.initElement,this),this.initialize=b(this.initialize,this),this.onChange=b(this.onChange,this),this.updateOnEnter=b(this.updateOnEnter,this),this.update=b(this.update,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.tagName="tr",e.prototype.events={"keypress .edit":"updateOnEnter","change .edit":"onChange"},e.prototype.template=_.template('    <td style="text-align:right;padding-right:5px">{{name}}</td>    <td>        <input id="{{id}}" class="edit" type="{{type}}" value="{{value}}"/>    </td>    '),e.prototype.update=function(a){var b;return b={},b[this.attrName]=a,this.model.setAttr(b)},e.prototype.updateOnEnter=function(a){return 13===a.keyCode?this.update(this.input.val()):void 0},e.prototype.onChange=function(){return"color"===this.inputType?this.update(this.input.val()):void 0},e.prototype.initialize=function(){return this.attrName=this.options.attrName,this.inputType=this.options.inputType,this.listenTo(this.model,"update",this.render),this.initElement()},e.prototype.initElement=function(){var a;return a={type:this.inputType,id:"property-edit-"+this.attrName,name:this.attrName,value:""},this.$el.html(this.template(a))},e.prototype.render=function(){var a;return a=this.model?this.model.get(this.attrName):"",this.input=this.$(".edit"),this.input.val(a),this},e.prototype.clear=function(){return this.input.val("")},e}(Backbone.View)}.call(this),function(){var a,b,c=function(a,b){return function(){return a.apply(b,arguments)}},d={}.hasOwnProperty,e=function(a,b){function c(){this.constructor=a}for(var e in b)d.call(b,e)&&(a[e]=b[e]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};this.SelectLineView=function(b){function d(){return this._setProperty=c(this._setProperty,this),a=d.__super__.constructor.apply(this,arguments)}return e(d,b),d.prototype.initialize=function(){return this._setProperty(),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"remove",this.remove)},d.prototype._setProperty=function(){return $(this.el).attr({fill:"none",stroke:"gray","stroke-width":"1","stroke-dasharray":"5","stroke-dashoffset":"10"})},d.prototype.render=function(){var a,b;return a=this.model.getBBoxPoints(),b="M "+a[0].x+" "+a[0].y+" L "+a[1].x+" "+a[1].y+" L "+a[3].x+" "+a[3].y+" L "+a[2].x+" "+a[2].y+"z",$(this.el).attr("d",b)},d}(Backbone.View),this.CloneSelectLineView=function(a){function d(){return this._setProperty=c(this._setProperty,this),b=d.__super__.constructor.apply(this,arguments)}return e(d,a),d.prototype._setProperty=function(){return $(this.el).attr({fill:"blue","fill-opacity":"0.5",stroke:"gray","stroke-width":"1","stroke-dasharray":"5","stroke-dashoffset":"10"})},d}(SelectLineView)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SelectLineListView=function(c){function e(){return this.remove=b(this.remove,this),this.clear=b(this.clear,this),this.render=b(this.render,this),this.addItem=b(this.addItem,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.item_list=new SvgElementList,this.item_list.bind("add",this.addItem),this.line_view_class=this.options.line_view_class,this.views=[]},e.prototype.addItem=function(a){var b;return b=SVGUtil.createTag("path"),$(this.el).append(b),this.line_view_class?this.views.push(new this.line_view_class({el:b,model:a})):this.views.push(new SelectLineView({el:b,model:a}))},e.prototype.render=function(){var a,b,c,d,e;for(d=this.views,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.render());return e},e.prototype.clear=function(){return this.views.forEach(function(a){return a.remove()}),this.views=[],this.item_list.reset()},e.prototype.remove=function(){return this.clear(),e.__super__.remove.call(this)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SelectRegionControlView=function(c){function e(){return this.regionDrop=b(this.regionDrop,this),this._getPosition=b(this._getPosition,this),this.regionDragging=b(this.regionDragging,this),this.startSelectRegion=b(this.startSelectRegion,this),this.isContainPoint=b(this.isContainPoint,this),this.render=b(this.render,this),this.show=b(this.show,this),this.hide=b(this.hide,this),this.clear=b(this.clear,this),this._size=b(this._size,this),this._getButtomRightPoint=b(this._getButtomRightPoint,this),this._getLeftTopPoint=b(this._getLeftTopPoint,this),this.setEnd=b(this.setEnd,this),this.setStart=b(this.setStart,this),this._setStyle=b(this._setStyle,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.canvas=this.options.canvas,this.region_el=SVGUtil.createTag("rect"),this._setStyle(),$(this.el).append(this.region_el)},e.prototype._setStyle=function(){return $(this.region_el).attr("fill","none"),$(this.region_el).attr("stroke","black"),$(this.region_el).attr("stroke-width","1"),$(this.region_el).attr("stroke-dasharray","5"),$(this.region_el).attr("stroke-dashoffset","10")},e.prototype.setStart=function(a){return this.start=a},e.prototype.setEnd=function(a){return this.end=a},e.prototype._getLeftTopPoint=function(){return{x:Math.min(this.start.x,this.end.x),y:Math.min(this.start.y,this.end.y)}},e.prototype._getButtomRightPoint=function(){return{x:Math.max(this.start.x,this.end.x),y:Math.max(this.start.y,this.end.y)}},e.prototype._size=function(a,b){return{width:b.x-a.x,height:b.y-a.y}},e.prototype.clear=function(){return this.start=null,this.end=null,$(this.region_el).attr("width",0),$(this.region_el).attr("height",0),this.hide()},e.prototype.hide=function(){return this.$el.hide()},e.prototype.show=function(){return this.$el.show()},e.prototype.render=function(){var a,b,c;if(this.start&&this.end)return b=this._getLeftTopPoint(),a=this._getButtomRightPoint(),c=this._size(b,a),$(this.region_el).attr("width",c.width),$(this.region_el).attr("height",c.height),$(this.el).attr("transform","translate("+b.x+", "+b.y+")")},e.prototype.isContainPoint=function(a){var b,c;return c=this._getLeftTopPoint(),b=this._getButtomRightPoint(),c.x<a.x&&a.x<b.x&&c.y<a.y&&a.y<b.y},e.prototype.startSelectRegion=function(a){return this.clear(),this.show(),this.setStart(this._getPosition(a)),$(document).mousemove(this.regionDragging),$(document).mouseup(this.regionDrop)},e.prototype.regionDragging=function(a){return this.setEnd(this._getPosition(a)),this.render()},e.prototype._getPosition=function(a){var b;return b=$(this.canvas.el).offset(),{x:a.pageX-b.left,y:a.pageY-b.top}},e.prototype.regionDrop=function(a){return $(document).unbind("mousemove",this.regionDragging),$(document).unbind("mouseup",this.regionDrop),this.setEnd(this._getPosition(a)),this.trigger("onRegionDrop",this),this.clear()},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SnapItemView=function(c){function e(){return this.render=b(this.render,this),this.clear=b(this.clear,this),this.createSvgRect=b(this.createSvgRect,this),this.setStyle=b(this.setStyle,this),this.addItem=b(this.addItem,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.items=[],this.setStyle()},e.prototype.addItem=function(a){return this.items.push(this.createSvgRect(a))},e.prototype.setStyle=function(){return this.$el.attr({fill:"blue","fill-opacity":"0.4"})},e.prototype.createSvgRect=function(a){var b,c,d;return b=SVGUtil.createTag("path"),c=a.getBBoxPoints(),d="M "+c[0].x+" "+c[0].y+" L "+c[1].x+" "+c[1].y+" L "+c[3].x+" "+c[3].y+" L "+c[2].x+" "+c[2].y+"z",$(b).attr("d",d),b},e.prototype.clear=function(){return this.items=[],this.$el.empty()},e.prototype.render=function(){var a,b,c,d,e,f=this;for(this.$el.empty(),d=this.items,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(function(a){return f.$el.append(a)}(a));return e},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SnapLineView=function(c){function e(){return this.render=b(this.render,this),this.clear=b(this.clear,this),this.createSvgLine=b(this.createSvgLine,this),this.setStyle=b(this.setStyle,this),this.addLineUsePoint=b(this.addLineUsePoint,this),this.addLine=b(this.addLine,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.lines=[],this.setStyle()},e.prototype.addLine=function(a){return this.lines.push(a)},e.prototype.addLineUsePoint=function(a,b){return this.addLine(this.createSvgLine(a,b))},e.prototype.setStyle=function(){return this.$el.attr({"stroke-width":"2",stroke:"red",opacity:"1"})},e.prototype.createSvgLine=function(a,b){var c;return c=SVGUtil.createTag("line"),$(c).attr({x1:a.x,y1:a.y,x2:b.x,y2:b.y}),c},e.prototype.clear=function(){return this.lines=[],this.$el.empty()},e.prototype.render=function(){var a,b,c,d,e,f=this;for(this.$el.empty(),d=this.lines,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(function(a){return f.$el.append(a)}(a));return e},e}(Backbone.View)}.call(this),function(){this.Snapping=function(){function a(){}return a.getNearPoints=function(a,b){var c,d,e,f;for(c=[],e=0,f=a.length;f>e;e++)d=a[e],_.each(b,function(a){var b,e;return b=Math.abs(d.x-a.point.x),e=Math.abs(d.y-a.point.y),5>b&&c.push({type:"x",p:d,snap_point:a.point,dist_x:b,dist_y:e,obj:a}),5>e?c.push({type:"y",p:d,snap_point:a.point,dist_x:b,dist_y:e,obj:a}):void 0});return c},a.getSnap=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;for(null==c&&(c=!0),d=SvgCanvasBase,o=[],e=d.mainCanvas.getCTM(),c?(f=cloneControlView.item_list.map(function(a){return a.get("origin_model")}),n=d.item_list.filter(function(a){return!_.contains(f,a)})):n=d.item_list.toArray(),r=function(a){return _.each(a.getSnapPoints(),function(b){return o.push({type:"item",item:a,point:b})})},s=0,u=n.length;u>s;s++)g=n[s],r(g);for(l=[],l=a.getNearPoints(b,o),j=_.first(_.sortBy(_.filter(l,function(a){return"x"===a.type}),function(a){return a.dist_x})),k=_.first(_.sortBy(_.filter(l,function(a){return"y"===a.type}),function(a){return a.dist_y})),snap_line_view.clear(),snap_item_view.clear(),h=SVGUtil.createPoint(0,0),j&&(p=j.snap_point.x,h.x=j.p.x-j.snap_point.x,snap_line_view.addLineUsePoint({x:p,y:j.p.y},{x:p,y:j.snap_point.y})),k&&(q=k.snap_point.y,h.y=k.p.y-k.snap_point.y,snap_line_view.addLineUsePoint({x:k.p.x,y:q},{x:k.snap_point.x,y:q})),w=[j,k],t=0,v=w.length;v>t;t++)i=w[t],i&&"item"===i.obj.type&&snap_item_view.addItem(i.obj.item);return snap_line_view.render(),snap_item_view.render(),m=function(){return snap_line_view.clear(),snap_item_view.clear(),$(document).unbind("mouseup",m)},$(document).on("mouseup",m),h},a}.call(this)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgGridView=function(c){function e(){return this.render=b(this.render,this),this.clear=b(this.clear,this),this.show=b(this.show,this),this.hide=b(this.hide,this),this.isVisible=b(this.isVisible,this),this.createSvgLine=b(this.createSvgLine,this),this.setStyle=b(this.setStyle,this),this.snapPoints=b(this.snapPoints,this),this.createYLine=b(this.createYLine,this),this.createXLine=b(this.createXLine,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.lines=[],this.width=this.options.width,this.height=this.options.height,this.gridsize=10,this.createXLine(),this.createYLine(),this.setStyle()},e.prototype.createXLine=function(){var a,b,c,d,e,f,g=this;for(b=0,c=function(){var b,c,d,e;for(e=[],a=b=0,c=this.width,d=this.gridsize;d>0?c>=b:b>=c;a=b+=d)e.push(a);return e}.call(this),f=[],d=0,e=c.length;e>d;d++)a=c[d],f.push(function(a){return g.lines.push(g.createSvgLine({x:a,y:0},{x:a,y:g.height})),b++}(a));return f},e.prototype.createYLine=function(){var a,b,c,d,e,f,g=this;for(b=0,c=function(){var b,c,d,e;for(e=[],a=b=0,c=this.height,d=this.gridsize;d>0?c>=b:b>=c;a=b+=d)e.push(a);return e}.call(this),f=[],d=0,e=c.length;e>d;d++)a=c[d],f.push(function(a){return g.lines.push(g.createSvgLine({y:a,x:0},{y:a,x:g.width})),b++}(a));return f},e.prototype.snapPoints=function(){var a,b,c,d,e,f,g,h;for(c=[],d=function(){var a,c,d,e;for(e=[],b=a=0,c=this.width,d=this.gridsize;d>0?c>=a:a>=c;b=a+=d)e.push(b);return e}.call(this),e=0,g=d.length;g>e;e++)b=d[e],c.push({x:b,y:0});for(a=function(){var a,c,d,e;for(e=[],b=a=0,c=this.height,d=this.gridsize;d>0?c>=a:a>=c;b=a+=d)e.push(b);return e}.call(this),f=0,h=a.length;h>f;f++)b=a[f],c.push({x:0,y:b});return c},e.prototype.setStyle=function(){return this.$el.attr({"stroke-width":"0.5",stroke:"gray",opacity:"1"})},e.prototype.createSvgLine=function(a,b,c){var d,e;return e=c||{},d=$(SVGUtil.createTag("line")),d.attr(_.extend({x1:a.x,y1:a.y,x2:b.x,y2:b.y},e)),d},e.prototype.isVisible=function(){return"none"!==this.$el.css("display")},e.prototype.hide=function(){return this.$el.hide()},e.prototype.show=function(){return this.$el.show()},e.prototype.clear=function(){return this.lines=[]},e.prototype.render=function(){var a,b,c,d,e,f=this;for(this.$el.empty(),d=this.lines,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(function(a){return f.$el.append(a)}(a));return e},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgCanvas=function(c){function e(){return this.deleteSelectdItem=b(this.deleteSelectdItem,this),this._getPosition=b(this._getPosition,this),this._getMovedPosition=b(this._getMovedPosition,this),this.moveDrop=b(this.moveDrop,this),this.moveDragging=b(this.moveDragging,this),this.mousedown=b(this.mousedown,this),this.group=b(this.group,this),this.unGroup=b(this.unGroup,this),this.unGroupSelectedItem=b(this.unGroupSelectedItem,this),this.groupSelectedItem=b(this.groupSelectedItem,this),this.zoom=b(this.zoom,this),this.addZoomCenter=b(this.addZoomCenter,this),this.setControlViewEvent=b(this.setControlViewEvent,this),this.addElement=b(this.addElement,this),this.onAddItem=b(this.onAddItem,this),this.removeItem=b(this.removeItem,this),this.generateId=b(this.generateId,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"mousedown",mousewheel:"onMouseWheel"}},e.prototype.initialize=function(){return this.mainCanvas=this.options.mainCanvas,this.manager=this.options.manager,this.control=this.options.control,this.zoomValue=1,this.unique_index=0,this.item_list=new SvgElementList,this.item_list.bind("add",this.onAddItem)},e.prototype.generateId=function(){var a;return a=this.unique_index++,"item-"+a},e.prototype.getItems=function(){return this.item_list},e.prototype.removeItem=function(a){return this.item_list.remove(a)},e.prototype.onAddItem=function(a){var b;return b=new SvgElementView({model:a,el:a.el}),this.setControlViewEvent(b),b.render()},e.prototype.addElement=function(a){var b;return $(a).attr("id",this.generateId()),$(a).attr("class","svg-control-item"),$(this.mainCanvas).append(a),b=new SvgElement,b.setElement(a),this.item_list.add(b),b},e.prototype.setControlViewEvent=function(a){var b=this;return["onMouseDown","onDblClick","onClick"].forEach(function(c){return a.bind(c,function(a,d){return b.manager.onEvent(c,a,d)})})},e.prototype.onMouseWheel=function(a){var b,c,d,e;return a.altKey?(b=this.$el.offset(),e=a.originalEvent,c={x:e.pageX-b.left,y:e.pageY-b.top},d=Math.pow(1.02,e.wheelDelta/10),this.zoom(d*this.zoomValue,c),a.preventDefault()):void 0},e.prototype.addZoomCenter=function(a){return this.zoom(this.zoomValue+a,{x:$(this.el).width()/2,y:$(this.el).height()/2})},e.prototype.zoom=function(a,b,c){var d,e,f,g,h,i,j;return null==c&&(c=!0),.05>a||a>100?void 0:(d=this.mainCanvas,g=SVGUtil.createPoint(b.x,b.y),e=d.getCTM(),g=g.matrixTransform(e.inverse()),h=SVGUtil.toD3Transform(e),this.zoomValue=a,i=g.x,j=g.y,f=void 0,c?(a/=h.scale[0],f=SVGUtil.SVG.createSVGMatrix().translate(i,j).scale(a).translate(-i,-j),f=e.multiply(f)):f=SVGUtil.SVG.createSVGMatrix().translate(i,j).scale(a).translate(-i,-j),SVGUtil.setMatrixTransform(d,f),this.trigger("onZoom",{sender:this,pos:g,scale:a}))},e.prototype.groupSelectedItem=function(){var a,b;return this.control.item_list.length>0?(a=this.control.item_list.map(function(a){return a.get("origin_model")}),b=this.group(a),this.control.initControls([b])):void 0},e.prototype.unGroupSelectedItem=function(){return this.control.isOneItem()?(this.unGroup(this.control.firstOriginalItem()),this.control.clear()):void 0},e.prototype.unGroup=function(a){var b,c=this;return b=SVGUtil.localMatrix(a.el),_.each($(a.el).children(),function(a){var d;return d=b.multiply(SVGUtil.localMatrix(a)),SVGUtil.setMatrixTransform(a,d),c.addElement(a)}),this.item_list.remove(a)},e.prototype.group=function(a){var b,c,d=this;return b=this.mainCanvas,c=SVGUtil.createTag("g"),$(b).append(c),a=a.sort(function(a,b){return a.$el.index()-b.$el.index()}),a.forEach(function(a){return a.group(),$(c).append(a.el),d.item_list.remove(a)}),this.addElement(c)},e.prototype.mousedown=function(a){return this.pre_position=a,this.manager.reset(),a.altKey&&($(document).mousemove(this.moveDragging),$(document).mouseup(this.moveDrop)),this.manager.onEvent("onMouseDown",this,a)},e.prototype.moveDragging=function(a){var b,c,d,e;return e=this._getMovedPosition(a),d=SVGUtil.createPoint(e.x,e.y),b=this.mainCanvas.getCTM(),c=b.inverse(),c.e=0,c.f=0,d=d.matrixTransform(c),SVGUtil.setMatrixTransform(this.mainCanvas,b.translate(d.x,d.y)),this.pre_position=a,this.trigger("onZoom",this)},e.prototype.moveDrop=function(){return $(document).unbind("mousemove",this.moveDragging),$(document).unbind("mouseup",this.moveDrop)},e.prototype._getMovedPosition=function(a){var b,c;return b=a.pageX-this.pre_position.pageX,c=a.pageY-this.pre_position.pageY,{x:b,y:c}},e.prototype._getPosition=function(a){var b;return b=$(this.el).offset(),{x:a.pageX-b.left,y:a.pageY-b.top}},e.prototype.deleteSelectdItem=function(){var a=this;return this.control.item_list.each(function(b){return a.removeItem(b.get("origin_model"))}),this.control.clear()},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgElementView=function(c){function e(){return this.remove=b(this.remove,this),this.onMouseDown=b(this.onMouseDown,this),this.onDblClick=b(this.onDblClick,this),this.onClick=b(this.onClick,this),this.onContextmenu=b(this.onContextmenu,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.events=function(){return{mousedown:"onMouseDown",click:"onClick",dblclick:"onDblClick"}},e.prototype.initialize=function(){return this.model.on("remove",this.remove)},e.prototype.onContextmenu=function(){return!1},e.prototype.onClick=function(a){return this.trigger("onClick",this,a)},e.prototype.onDblClick=function(a){return this.trigger("onDblClick",this,a),a.stopPropagation()},e.prototype.onMouseDown=function(a){return this.model.isLocked()?void 0:this.trigger("onMouseDown",this,a)},e.prototype.remove=function(){return this.model.isGrouped()?(this.stopListening(),this.undelegateEvents()):e.__super__.remove.call(this)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgItemListView=function(c){function e(){return this.clickedItem=b(this.clickedItem,this),this.mouseDraggingItem=b(this.mouseDraggingItem,this),this.mouseUpItem=b(this.mouseUpItem,this),this.mouseDownItem=b(this.mouseDownItem,this),this.addOne=b(this.addOne,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.model.bind("add",this.addOne)},e.prototype.addOne=function(a){var b;return b=new SvgItemView({model:a}),b.bind("clicked",this.clickedItem),b.bind("onMouseDown",this.mouseDownItem),b.bind("onMouseUp",this.mouseUpItem),b.bind("onMouseDragging",this.mouseDraggingItem),$(this.el).append(b.render().el),setTimeout(function(){return b.fit()},0),$(b.el).attr("class","svg-item")},e.prototype.mouseDownItem=function(a,b){return this.trigger("mouseDown.item",a,b)},e.prototype.mouseUpItem=function(a,b){return this.trigger("mouseUp.item",a,b)},e.prototype.mouseDraggingItem=function(a,b){return this.trigger("mouseDragging.item",a,b)},e.prototype.clickedItem=function(a){return this.trigger("clicked.item",a)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgItemToolView=function(c){function e(){return this.mouseDraggingItem=b(this.mouseDraggingItem,this),this.mouseUpItem=b(this.mouseUpItem,this),this.getSelectedItemElement=b(this.getSelectedItemElement,this),this._updateDraggingItemPosition=b(this._updateDraggingItemPosition,this),this.mouseDownItem=b(this.mouseDownItem,this),this._getDraggingItemElement=b(this._getDraggingItemElement,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this._canvas=this.options.canvas,this._mainCanvas=this._canvas.mainCanvas,this.bind("mouseDown.item",this.mouseDownItem),this.bind("mouseDragging.item",this.mouseDraggingItem),this.bind("mouseUp.item",this.mouseUpItem),e.__super__.initialize.call(this)},e.prototype._getDraggingItemElement=function(){return $("#item-dragging")},e.prototype.mouseDownItem=function(a,b){var c,d;return $(document).mousemove(a.onDragging),d=function(b){return a.onDrop&&a.onDrop(b),$(document).unbind("mousemove",a.onDragging),$(document).unbind("mouseup",d),b.preventDefault(),b.stopPropagation()},$(document).mouseup(d),$("#svg-item-tool").show(),c=this.getSelectedItemElement(a).cloneNode(!0),this._getDraggingItemElement().append(c),this._updateDraggingItemPosition(b),b.preventDefault(),b.stopPropagation()},e.prototype._updateDraggingItemPosition=function(a){var b,c,d;return d=this._mainCanvas.getScreenCTM(),c=SVGUtil.createPoint(a.pageX,a.pageY),b=d.inverse(),c=c.matrixTransform(b),SVGUtil.setMatrixTransform(this._getDraggingItemElement()[0],d.translate(c.x,c.y))},e.prototype.getSelectedItemElement=function(a){return $(a.el).find("svg g").children()[0]},e.prototype.mouseUpItem=function(a,b){var c,d,e,f,g,h;return c=this._canvas.$el,g=c.position(),f=function(){return g.left<b.pageX&&b.pageX<c.width()+g.left&&g.top<b.pageY&&b.pageY<c.height()+g.top},h=this._getDraggingItemElement().children()[0].getScreenCTM(),this._getDraggingItemElement().empty(),$("#svg-item-tool").hide(),f()?(e=this.getSelectedItemElement(a).cloneNode(!0),$(this._mainCanvas).append(e),d=this._mainCanvas.getScreenCTM(),SVGUtil.setMatrixTransform(e,d.inverse().multiply(h)),this._canvas.addElement(e)):void 0},e.prototype.mouseDraggingItem=function(a,b){return this._updateDraggingItemPosition(b)},e}(SvgItemListView)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.SvgItemView=function(c){function e(){return this.click=b(this.click,this),this.onDrop=b(this.onDrop,this),this.onDragging=b(this.onDragging,this),this.onMouseDown=b(this.onMouseDown,this),this.fit=b(this.fit,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.template=_.template('    <svg        height="40px"        width="40px"        viewBox="0 10 100 100"        xmlns="http://www.w3.org/2000/svg"        xmlns:xlink="http://www.w3.org/1999/xlink">      <g>      {{contents}}      </g>    </svg>'),e.prototype.events=function(){return{click:"click",mousedown:"onMouseDown"}},e.prototype.render=function(){return $(this.el).css("width","40px"),$(this.el).css("height","40px"),$(this.el).css("border","1px solid #ccc"),$(this.el).css("float","left"),$(this.el).css("margin","1px"),$(this.el).html(e.template(this.model.attributes)),this},e.prototype.fit=function(){var a,b,c,d;return c=$(this.el).find("g")[0],b=$(this.el).find("svg")[0],a=c.getBBox(),d=a.x+" "+a.y+" "+a.width+" "+a.height,b.setAttribute("viewBox",d)},e.prototype.onMouseDown=function(a){return this.trigger("onMouseDown",this,a)},e.prototype.onDragging=function(a){return this.trigger("onMouseDragging",this,a)},e.prototype.onDrop=function(a){return this.trigger("onMouseUp",this,a)},e.prototype.click=function(){return this.trigger("clicked",this)},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.ZOrderControl=function(c){function e(){return this._toBottom=b(this._toBottom,this),this._toTop=b(this._toTop,this),this._bringBack=b(this._bringBack,this),this._bringForward=b(this._bringForward,this),this._sort=b(this._sort,this),this._move=b(this._move,this),this._getSelectedElement=b(this._getSelectedElement,this),this.toBottom=b(this.toBottom,this),this.toTop=b(this.toTop,this),this.bringBack=b(this.bringBack,this),this.bringForward=b(this.bringForward,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return this.canvas=this.options.canvas,this.canvas_el=this.canvas.mainCanvas},e.prototype.bringForward=function(){return this._move(this._bringForward)},e.prototype.bringBack=function(){return this._move(this._bringBack)},e.prototype.toTop=function(){return this._move(this._toTop)},e.prototype.toBottom=function(){return this._move(this._toBottom)},e.prototype._getSelectedElement=function(){return this.canvas.control.item_list.map(function(a){return $(a.get("origin_model").el)})},e.prototype._move=function(a){return a(this._getSelectedElement()),this.trigger("onMove",this)},e.prototype._sort=function(a){return a.sort(function(a,b){return b.index()-a.index()})},e.prototype._bringForward=function(a){var b,c,d,e;for(a=this._sort(a).reverse(),e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.insertAfter(b.next()));return e},e.prototype._bringBack=function(a){var b,c,d,e;for(a=this._sort(a),e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(b.insertBefore(b.prev()));return e},e.prototype._toTop=function(a){var b,c,d,e;for(a=this._sort(a).reverse(),e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push($(this.canvas_el).append(b));return e},e.prototype._toBottom=function(a){var b,c,d,e;for(a=this._sort(a),e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push($(this.canvas_el).prepend(b));return e},e}(Backbone.View)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PanelBaseView=function(c){function e(){return this.render=b(this.render,this),this.loadFile=b(this.loadFile,this),this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return e.__super__.initialize.call(this),this.control=this.options.control,this._defs_id=this.options.defs_id,this._element_key=this.options.element_key,this._template=_.template('<rect x="0" y="0" fill="url(#{{element_id}})" width="100" height="100"></rect>')
},e.prototype.setTemplate=function(a){return this._template=a},e.prototype.loadFile=function(a){return PanelViewHelper.loadFile(a,this._defs_id,this.render)},e.prototype.render=function(){var a,b,c,d,e,f,g,h;for(console.log("PanelBaseView render",this,this.model),c=this.model,b=this._element_key,d=this._template,g=$(this._defs_id).children(),h=[],e=0,f=g.length;f>e;e++)a=g[e],h.push(function(a){var e,f,g;return e=$(a).attr("id"),g=d({element_id:e}),f={contents:g},f[b]=e,c.add(new SvgItem(f))}(a));return h},e.prototype.svgApplyFill=function(a,b,c){var d,e,f;return this.control.isOneItem()?(f=b,d=$("#"+f),e=$("#"+a)[0].cloneNode(!0),d.length>0?(d.empty(),d.append(e.childNodes)):($(e).attr("id",f),$("#"+c).append(e)),this.control.firstOriginalItem().attr("fill","url(#"+f+")")):void 0},e}(SvgItemListView)}.call(this),function(){this.PanelViewHelper=function(){function a(){}return a.loadFile=function(b,c,d){return a.getFile(b,function(a){var b,e;return e=_.template('            <svg                xmlns="http://www.w3.org/2000/svg"                xmlns:xlink="http://www.w3.org/1999/xlink">              <defs id="temp-data">              {{data}}              </defs>            </svg>'),b=$("<div>"),b.html(e({data:a})),$("body").append(b),$(c).append($("#temp-data").children()),b.remove(),d()})},a.getFile=function(a,b){return $.ajax({type:"GET",url:a,success:b,error:function(a,b){return console.log(b)}})},a}.call(this)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.GradientPanelView=function(c){function e(){return this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return e.__super__.initialize.call(this),this.bind("clicked.item",function(a){var b,c;return b=a.model.get("gradient_id"),this.control.isOneItem()&&(c=this.control.firstOriginalItem().$el.attr("id")+"-grad"),this.svgApplyFill(b,c,"item-defs")})},e}(PanelBaseView)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.PatternPanelView=function(c){function e(){return this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return e.__super__.initialize.call(this),this.bind("clicked.item",function(a){var b,c;return c=a.model.get("pattern_id"),this.control.isOneItem()&&(b=this.control.firstOriginalItem().$el.attr("id")+"-pattern"),this.svgApplyFill(c,b,"item-defs")})},e}(PanelBaseView)}.call(this),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}},c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};this.FilterPanelView=function(c){function e(){return this.initialize=b(this.initialize,this),a=e.__super__.constructor.apply(this,arguments)}return d(e,c),e.prototype.initialize=function(){return e.__super__.initialize.call(this),this.bind("clicked.item",function(a){var b;return b=a.model.get("filter_id"),this.control.isOneItem()?this.control.firstOriginalItem().attr("filter","url(#"+b+")"):void 0})},e}(PanelBaseView)}.call(this),function(){this.SVGUtil=function(){function a(){}return a.SVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),a.toD3Transform=function(b){return d3.transform("matrix("+a.toStringMatrix(b)+")")},a.toStringMatrix=function(a){var b,c;return c=function(){var c,d,e,f;for(e=["a","b","c","d","e","f"],f=[],c=0,d=e.length;d>c;c++)b=e[c],f.push(a[b].toString());return f}(),c.join()},a.TransformMatrix=function(b){return a.Transform(b).matrix},a.Transform=function(a){var b;return b=document.createElementNS("http://www.w3.org/2000/svg","g"),b.setAttribute("transform",a.toString()),b.transform.baseVal.consolidate()},a.createPoint=function(b,c){var d;return d=a.SVG.createSVGPoint(),d.x=b,d.y=c,d},a.createTag=function(a){return document.createElementNS("http://www.w3.org/2000/svg",a)},a.setMatrixTransform=function(b,c){var d;return d=a.SVG.createSVGTransform(),d.setMatrix(c),a.setTransform(b,d)},a.setTransform=function(a,b){return a.transform.baseVal.initialize(b)},a.localMatrix=function(b){var c;return c=b.transform.baseVal.consolidate(),c?c.matrix:a.SVG.createSVGMatrix()},a}.call(this)}.call(this),function(){this.SvgExporter=function(){function a(){}return a.prototype.toSvg=function(a,b,c){var d,e,f,g,h;return e=a.cloneNode(!0),d=new XMLSerializer,$(e).attr("id",""),$(e).attr("style",""),f=d.serializeToString(e),h="data:image/svg+xml, ",g=h+f,window.open(g,b,c)},a}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.SvgTextEditor=function(){function b(b,c){this.bindEvent=a(this.bindEvent,this),this.onClickEvent=a(this.onClickEvent,this),this.unbindClickEvent=a(this.unbindClickEvent,this),this.showInput=a(this.showInput,this),this.keyDown=a(this.keyDown,this),this.disable=a(this.disable,this),this.remove=a(this.remove,this),this.keyPress=a(this.keyPress,this),this.updateTextValue=a(this.updateTextValue,this),this.setTextElement=a(this.setTextElement,this),this.unbindEvent=a(this.unbindEvent,this),this.getCaretPosition=a(this.getCaretPosition,this),this.getCaretPositionFromPoint=a(this.getCaretPositionFromPoint,this),this.setOnDisable=a(this.setOnDisable,this),this.parent_el=b,this.text_el=c,this.cursor_el=document.createElementNS("http://www.w3.org/2000/svg","rect"),$(this.cursor_el).css("fill","black"),$(this.cursor_el).css("stroke","white"),$(this.cursor_el).attr("width","2"),$(this.cursor_el).attr("stroke-width","0.4"),$(this.parent_el).append(this.cursor_el),this.input_el=document.createElement("input"),$(this.input_el).attr("size","100"),$(this.input_el).attr("type","text"),$(this.input_el).attr("style","z-index:1000;position:absolute;left:0;top:0;display:none;"),$("body").prepend(this.input_el),this.edit_cursor=new EditCursor(this.cursor_el,this.text_el)}return b.prototype.setOnDisable=function(a){return this.onDisable=a},b.prototype.getCaretPositionFromPoint=function(a,b){var c,d,e,f,g,h,i,j,k,l;if(k=a.getNumberOfChars(),k>0){for(f=a.getStartPositionOfChar(0),g=l=0;k>=0?k>=l:l>=k;g=k>=0?++l:--l)if(e=a.getEndPositionOfChar(g),j=a.getStartPositionOfChar(g),c=function(a,b){var c,d;return c=a.x-b.x,d=a.y-b.y,Math.sqrt(c*c+d*d)},i=c(j,f),d=c(e,f),h=c(b,f),h>=i&&d>=h)return Math.abs(i-h)>Math.abs(d-h)?g+1:g;return g}return-1},b.prototype.getCaretPosition=function(a,b){var c,d,e,f,g;if(f=a.getNumberOfChars(),f>0){for(d=g=0;f>=0?f>=g:g>=f;d=f>=0?++g:--g)if(c=a.getEndPositionOfChar(d),e=a.getStartPositionOfChar(d),e.x<=b&&c.x>=b)return Math.abs(e.x-b)>Math.abs(c.x-b)?d+1:d;return d}return-1},b.prototype.unbindEvent=function(){return $(this.input_el).unbind("blur",this.unbindEvent),$(this.input_el).unbind("keydown",this.keyDown),$(this.input_el).unbind("keyup",this.keyPress),this.edit_cursor.disable(),$(this.input_el).hide(),this.onDisable&&this.onDisable()},b.prototype.setTextElement=function(a){return this.text_el=a,this.edit_cursor.text_element=a},b.prototype.updateTextValue=function(){var a;return a=this.input_el.value,$(this.text_el).text(a)},b.prototype.keyPress=function(){return this.updateTextValue(),this.edit_cursor.updateCharPos(this.input_el.selectionStart)},b.prototype.remove=function(){return $(this.cursor_el).remove(),$(this.input_el).remove()},b.prototype.disable=function(){return $(this.input_el).blur()},b.prototype.keyDown=function(a){return 13===a.keyCode?this.disable():this.updateTextValue(a)},b.prototype.showInput=function(a){var b;return b=$(this.input_el),b.show(),b.val(this.text_el.textContent),b.focus(),b[0].setSelectionRange(a,a)},b.prototype.unbindClickEvent=function(){return $(this.text_el).unbind("click",this.onClickEvent)},b.prototype.onClickEvent=function(a){var b,c,d,e,f;return f=SVGUtil.createPoint(a.pageX,a.pageY),d=this.text_el.getScreenCTM(),f=f.matrixTransform(d.inverse()),c=this.getCaretPositionFromPoint(this.text_el,f),this.edit_cursor.updateCharPos(c),this.showInput(c),e=$(this.input_el),b=this.text_el.getBBox(),d=this.text_el.getScreenCTM(),e.css("left",d.e+b.x),e.css("top",d.f+b.y+b.height+10),e.on("blur",this.unbindEvent),e.on("keydown",this.keyDown),e.on("keyup",this.keyPress)},b.prototype.bindEvent=function(){return $(this.text_el).on("click",this.onClickEvent)},b}(),this.EditCursor=function(){function b(b,c){this.blink=a(this.blink,this),this.startBlink=a(this.startBlink,this),this.clearBlink=a(this.clearBlink,this),this.updateCharPos=a(this.updateCharPos,this),this.setCursor=a(this.setCursor,this),this.disable=a(this.disable,this),this.pos=0,this.el=b,this.text_element=c,this.interval_blink,this.disable()}return b.prototype.disable=function(){return this.clearBlink(),$(this.el).hide()},b.prototype.setCursor=function(a){var b,c,d,e,f;return d=this.text_element.getNumberOfChars(),f=a>=d?this.text_element.getEndPositionOfChar(a):this.text_element.getStartPositionOfChar(a),SVGUtil.setMatrixTransform(this.el,this.text_element.getCTM()),b=$(this.el),a>=d?(e=this.text_element.getExtentOfChar(a-1),b.attr("x",e.x+e.width)):(e=this.text_element.getExtentOfChar(a),b.attr("x",e.x),b.attr("y",e.y)),c=this.text_element.getBBox(),b.attr("height",c.height),b.attr("width",1)},b.prototype.updateCharPos=function(a){return this.pos=a,this.setCursor(this.pos),$(this.el).show(),this.startBlink()},b.prototype.clearBlink=function(){return this.interval_blink&&clearInterval(this.interval_blink)},b.prototype.startBlink=function(){return this.clearBlink(),this.interval_blink=setInterval(this.blink,500)},b.prototype.blink=function(){return $(this.el).toggle()},b}()}.call(this),function(){this.VectorUtil=function(){function a(){}return a.cross=function(a,b){return a.x*b.y-a.y*b.x},a.dot=function(a,b){return a.x*b.x+a.y*b.y},a}()}.call(this),function(){var a=this;$(document).ready(function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;for(a.event_manager=new EventManager,a.cloneControlView=new CloneControlView({el:$("#clone-control-view"),line_wrapper:$("#clone-select-line-views"),select_el:$("#clone-selected-view"),manager:a.event_manager}),a.event_manager.setControl(a.cloneControlView),a.SvgCanvasBase=new SvgCanvas({el:$("#svg-canvas-base"),control:a.cloneControlView,mainCanvas:$("#svg-canvas")[0],manager:a.event_manager}),a.event_manager.setCanvas(a.SvgCanvasBase),a.cloneControlView.setCanvas(a.SvgCanvasBase),a.svgPathControl=new SvgPathControlView({el:$("#path-control-panel")}),cloneControlView.bind("onChangeList",function(){return cloneControlView.isOneItem()&&(a.event_manager.selected_item=null),cloneControlView.isOneItem()?void 0:svgPathControl.unbindItem()}),a.inspectorListView=new InspectorListView({control:a.cloneControlView,item_list:SvgCanvasBase.item_list}),$("#inspector-list").append(a.inspectorListView.el),a.SvgCanvasBase.bind("onZoom",function(){var b;return b=$(a.SvgCanvasBase.mainCanvas).attr("transform"),$(grid_view.el).attr("stroke-width",.5*(1/SvgCanvasBase.zoomValue)),$(grid_view.el).attr("transform",b),$("#clone-control-view-wapper").attr("transform",b),cloneControlView.render(),svgPathControl.render()}),a.SvgItems=new SvgItemList,a.SvgItemToolView=new SvgItemToolView({model:a.SvgItems,el:$("#svg-item-list"),canvas:SvgCanvasBase}),m=function(a){return SvgItems.add(new SvgItem({name:"item",contents:a}))},o=0,r=SvgSample.length;r>o;o++)j=SvgSample[o],m(j);for(a.patternItemsView=new PatternPanelView({model:new SvgItemList,el:$("#pattern-items"),control:cloneControlView,defs_id:"#pattern-defs",element_key:"pattern_id"}),a.gradientItemsView=new GradientPanelView({model:new SvgItemList,el:$("#gradient-items"),control:cloneControlView,defs_id:"#gradient-defs",element_key:"gradient_id"}),a.filterItemsView=new FilterPanelView({model:new SvgItemList,el:$("#filter-items"),control:cloneControlView,defs_id:"#filter-defs",element_key:"filter_id"}),a.filterItemsView.setTemplate(_.template('<rect x="10" y="10" filter="url(#{{element_id}})" fill="white" width="30" height="30"></rect>')),a.gradientItemsView.loadFile("partial/gradient_defs.html"),a.patternItemsView.loadFile("partial/pattern_defs.html"),a.filterItemsView.loadFile("partial/filter_defs.html"),a.orderControl=new ZOrderControl({canvas:a.SvgCanvasBase}),a.orderControl.bind("onMove",function(){return inspectorListView.sortByIndex()}),$("#export-button").click(function(){return SvgExport()}),a.grid_view=new SvgGridView({el:$("#svg-canvas-grid"),width:800,height:600}),a.grid_view.render(),a.snap_line_view=new SnapLineView({el:$("#snap-line-view")}),a.snap_item_view=new SnapItemView({el:$("#snap-item-view")}),$("#panel-tabs a").click(function(a){return a.preventDefault(),$(this).tab("show")}),u=_.map(_.range(1,30),function(a){return.1*a}),p=0,s=u.length;s>p;p++)c=u[p],k=_.template('<option value="{{val}}" {{option}}> {{name}}</option>'),i="",b=Math.round(100*c),100===b&&(i="selected"),$("#zoom-control").append(k({option:i,name:b+"%",val:c}));v=a.event_manager.modes;for(h in v)d=v[h],k=_.template('<option value="{{val}}" {{option}}> {{name}}</option>'),i="","control"===h&&(i="selected"),$("#mode-control").append(k({option:i,name:h,val:h}));for($("#mode-control").change(function(){return d=$("#mode-control").val(),a.event_manager.setMode(d)}),$("#zoom-control").change(function(){return SvgCanvasBase.zoom($("#zoom-control").val(),{x:400,y:300},!1)}),key("backspace, delete",function(a){return a.preventDefault(),SvgCanvasBase.deleteSelectdItem()}),key("c",function(){return $("#mode-control").val("control").trigger("change")}),key("t",function(){return $("#mode-control").val("text").trigger("change")}),key("p",function(){return $("#mode-control").val("path").trigger("change")}),f=function(a){return cloneControlView.item_list.length>0?cloneControlView.getControlItem().move(a):void 0},g=[{key:"up",x:0,y:-1},{key:"down",x:0,y:1},{key:"right",x:1,y:0},{key:"left",x:-1,y:0}],n=function(a){return key(a.key,function(b){return f({x:a.x,y:a.y}),b.preventDefault()})},q=0,t=g.length;t>q;q++)e=g[q],n(e);return $("#gradient-rotate").knob({change:function(a){var b,c,d,e,f,g;return f=cloneControlView.firstOriginalItem().el,c=f.getBBox(),g=$(f).attr("id")+"-grad",d=c.width/2,e=c.height/2,b="rotate("+a+")",$("#"+g)[0].setAttributeNS(null,"gradientTransform",b)}}),l=function(){var a,b,c,d,e,f,g,h;return e=cloneControlView.firstOriginalItem().el,b=e.getBBox(),f=$(e).attr("id")+"-pattern",c=b.width/2,d=b.height/2,h=$("#pattern-rotate").val(),g=Math.pow($("#pattern-slider").slider("value")/25,2),a="rotate("+h+", "+c+", "+d+") scale("+g+")",$("#"+f)[0].setAttributeNS(null,"patternTransform",a)},$("#pattern-rotate").knob({change:function(){return l()}}),$("#pattern-slider").slider({slide:function(){return l()}}),$("#grid-check").click(function(){return $("#grid-check")[0].checked?grid_view.show():grid_view.hide()}),$(".navbar-fixed-top").hide(),$(".container-fluid").css("padding-top","0px"),$.contextMenu({selector:"#svg-canvas-base",items:{forward:{name:"forward",callback:function(){return orderControl.bringForward()}},back:{name:"back",callback:function(){return orderControl.bringBack()}},top:{name:"top",callback:function(){return orderControl.toTop()}},bottom:{name:"bottom",callback:function(){return orderControl.toBottom()}},group:{name:"group",callback:function(){return SvgCanvasBase.groupSelectedItem()}},un_group:{name:"ungroup",callback:function(){return SvgCanvasBase.unGroupSelectedItem()}},unite:{name:"unite",callback:function(){return excutePathBoolean("unite")}},intersect:{name:"intersect",callback:function(){return excutePathBoolean("intersect")}},subtract:{name:"subtract",callback:function(){return excutePathBoolean("subtract")}},divide:{name:"divide",callback:function(){return excutePathBoolean("divide")}},exclude:{name:"exclude",callback:function(){return excutePathBoolean("exclude")}}}}),initPropertyEdit()}),this.excutePathBoolean=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(2===cloneControlView.item_list.length){for(c=cloneControlView.item_list.at(0).get("origin_model"),d=cloneControlView.item_list.at(1).get("origin_model"),g=new paper.CompoundPath,h=new paper.CompoundPath,e=function(a){return new paper.Matrix(a.a,a.b,a.c,a.d,a.e,a.f)},g.setPathData($(c.el).attr("d")),h.setPathData($(d.el).attr("d")),g.transform(e(c.getLocalMatrix())),h.transform(e(d.getLocalMatrix())),m=[g,h],i=0,k=m.length;k>i;i++)for(f=m[i],n=f._children,j=0,l=n.length;l>j;j++)b=n[j],b.isClockwise()||b.reverse();return f=h[a](g),_(["exclude","divide"]).contains(a)?(f._children.forEach(function(a){var b;return b=SVGUtil.createTag("path"),console.log(a),$(b).attr({d:a.getPathData(),"fill-rule":"evenodd",transform:""}),SvgCanvasBase.addElement(b)}),SvgCanvasBase.removeItem(c),SvgCanvasBase.removeItem(d),cloneControlView.clear()):(c.attr({d:f.getPathData(),"fill-rule":"evenodd",transform:""}),SvgCanvasBase.removeItem(d),cloneControlView.initControls([c]))}},this.initPropertyEdit=function(){var a,b,c,d,e,f;for(b=new PropertyEditSetView({el:$("#property-table")}),f=["fill-spe","stroke-spe"],c=function(a){var c;return c=a,$("#property-edit-"+a).spectrum({showPalette:!0,showSelectionPalette:!0,maxPaletteSize:10,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],change:function(a){return b.prop_views[c.replace("-spe","")].update(a.toHexString())}})},d=0,e=f.length;e>d;d++)a=f[d],c(a);return cloneControlView.bind("onChangeList",function(){var c,d,e,f,g;if(cloneControlView.isOneItem()){for(c=cloneControlView.firstOriginalItem(),b.bindElement(c),f=["fill-spe","stroke-spe"],g=[],d=0,e=f.length;e>d;d++)a=f[d],g.push(function(a){return $("#property-edit-"+a).spectrum("set",$(c.el).attr(a.replace("-spe","")))}(a));return g}return b.clear()})},this.SvgExport=function(){return(new SvgExporter).toSvg($("#svg-canvas-wrap")[0],"svgfile","width=600, height=400")}}.call(this),function(){this.SvgSample=['<circle cx="30" cy="30" r="30" fill="black" />','<rect x="0" y="0" width="60" height="60" fill="white" stroke="black" stroke-width="1" />','<ellipse cx="100" cy="100" rx="60" ry="30" fill="white" stroke="black" stroke-width="1" />','<line x1="30" y1="30" x2="350" y2="30" style="stroke:#000000;stroke-width:3;" />','<rect x="0" y="0" width="60" height="60" fill="white" stroke="black" stroke-width="10" rx="10" fill-opacity="0"/>','<path  d="m0, 0l50,-86.6l50,86.6z"/>','<path transform="matrix(1 0 0 1 -290.902 -260.481)" d="M320.57759,329.54771c-16.18867,-16.1889 -16.18842,-42.41456 0.00039,-58.60337c16.1885,16.18891 16.18837,42.41462 -0.00039,58.60337z"></path>','<path d="M296.37796,276.28552c0.03854,-19.29356 3.81805,-41.04709 13.32033,-40.98555c9.50228,0.06154 13.6521,21.59305 13.71874,41.0383c0.06664,19.44525 -4.89249,38.94574 -13.32033,38.93074c-8.42784,-0.015 -13.75728,-19.68993 -13.71874,-38.98349z" transform="matrix(1 0 0 1 -293.484 -235.284)" fill-rule="evenodd"></path>','<path       d="M 174.28571,429.50505 104.88042,396.05244 37.976041,434.26207 48.34395,357.91629 -8.6701593,306.09387 67.142856,292.36219 l 31.667721,-70.23765 36.487113,67.85914 76.58584,8.41317 -53.26275,55.67093 z"       transform="translate(11.428571,-220)"       id="path2985"       style="" />','<text x="0" y="0" style="font-size:14pt">Text</text>','<text x="0" y="0" writing-mode="tb-rl" direction="ltr" glyph-orientation-vertical="auto" style="font-size:20pt">Text</text>','<path transform="scale(0.3)" d="m62.86963,236.11111c0,-76.31512 61.81525,-138.13037 138.13037,-138.13037c76.31512,0 138.13037,61.81525 138.13037,138.13037c0,76.31512 -61.81525,138.13037 -138.13037,138.13037c-76.31512,0 -138.13037,-61.81525 -138.13037,-138.13037z"/>','<path d="M100,100L100,200L200,200L200,100z"></path>','<path transform="matrix(1 0 0 1 -94.9266 -48.9701)" d="M145.54865,148.9436c-27.62432,0 -50.00002,-22.3757 -50.00002,-50.00002c0,-27.62432 22.3757,-50.00002 50.00002,-50.00002L245.46218,48.9436c27.62432,0 50.00002,22.3757 50.00002,50.00002c0,27.62432 -22.3757,50.00002 -50.00002,50.00002z" ></path>']}.call(this);